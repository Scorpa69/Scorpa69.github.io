<!--
title: ZABBIX
description: 
published: true
date: 2023-09-18T12:36:35.367Z
tags: 
editor: ckeditor
dateCreated: 2023-09-18T12:36:34.061Z
-->

<p>Voici la procédure pour déployer Zabbix avec Apache, MySQL et PHP dans un cluster Kubernetes Rancher :</p>
<p>Créez un espace de travail dans Rancher pour votre application Zabbix.</p>
<p>Dans l'espace de travail, créez un nouveau projet Kubernetes.</p>
<p>Créez un fichier zabbix.yaml avec le contenu suivant :</p>
<pre><code class="language-plaintext">apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: zabbix-mysql-pv-claim
  labels:
    app: zabbix
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 1Gi
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: zabbix-conf
  labels:
    app: zabbix
data:
  php.ini: |
    max_execution_time = 600
    memory_limit = 256M
    post_max_size = 32M
    upload_max_filesize = 16M
  zabbix.conf.php: |
    &lt;?php
    // Zabbix GUI configuration file
    global $DB;

    $DB['TYPE']     = 'MYSQL';
    $DB['SERVER']   = 'zabbix-mysql';
    $DB['PORT']     = '3306';
    $DB['DATABASE'] = 'zabbix';
    $DB['USER']     = 'zabbix';
    $DB['PASSWORD'] = 'zabbix';
    // SCHEMA is relevant only for IBM_DB2 database
    $DB['SCHEMA'] = '';

    $ZBX_SERVER      = 'zabbix-server';
    $ZBX_SERVER_PORT = '10051';
    $ZBX_SERVER_NAME = '';

    $IMAGE_FORMAT_DEFAULT = IMAGE_FORMAT_PNG;
---
apiVersion: v1
kind: Service
metadata:
  name: zabbix-mysql
  labels:
    app: zabbix
spec:
  ports:
    - port: 3306
  selector:
    app: zabbix
    tier: mysql
  clusterIP: None
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: zabbix-web-pv-claim
  labels:
    app: zabbix
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 1Gi
---
apiVersion: v1
kind: Service
metadata:
  name: zabbix-web
  labels:
    app: zabbix
spec:
  type: LoadBalancer
  ports:
    - port: 80
  selector:
    app: zabbix
    tier: web
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: zabbix-mysql
  labels:
    app: zabbix
spec:
  replicas: 1
  selector:
    matchLabels:
      app: zabbix
      tier: mysql
  template:
    metadata:
      labels:
        app: zabbix
        tier: mysql
    spec:
      containers:
        - name: zabbix-mysql
          image: mysql:5.7
          ports:
            - containerPort: 3306
          env:
            - name: MYSQL_ROOT_PASSWORD
              value: zabbix
            - name: MYSQL_DATABASE
              value: zabbix
            - name: MYSQL_USER
              value: zabbix
            - name: MYSQL_PASSWORD
              value: zabbix
          volumeMounts:
            - name: zabbix-mysql-persistent-storage
              mountPath: /var/lib/mysql
      volumes:
        - name: zabbix-mysql-persistent-storage
          persistentVolumeClaim:
            claimName: zabbix-mysql-pv-claim
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: zabbix-server
  labels:
    app: zabbix
spec:
  replicas: 1
  selector:
    matchLabels:
      app: zabbix
      tier: server
  template:
    metadata:
      labels:
        app: zabbix
        tier: server
    spec:
      containers:
        - name: zabbix-server
          image: zabbix/zabbix-server-mysql:latest
          env:
            - name: DB_SERVER_HOST
              value: zabbix-mysql
            - name: MYSQL_USER
              value: zabbix
            - name: MYSQL_PASSWORD
              value: zabbix
          ports:
            - containerPort: 10051
          volumeMounts:
            - name: zabbix-web-persistent-storage
              mountPath: /usr/share/zabbix
          command:
            - /bin/sh
            - -c
            - |
              set -e
              if [ ! -f /usr/share/zabbix/conf/zabbix.conf.php ]; then
                  cp /usr/share/zabbix/conf/zabbix.conf.php.example /usr</code></pre>
