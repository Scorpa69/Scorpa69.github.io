<!--
title: CROWDSEC
description: 
published: true
date: 2024-02-26T08:34:20.207Z
tags: 
editor: ckeditor
dateCreated: 2024-02-26T08:08:08.890Z
-->

<h1>Install sur PFSense</h1>
<p style="text-align:justify;"><strong>Sommaire [</strong><a href="https://www.it-connect.fr/tuto-installation-crowdsec-pare-feu-pfsense/#"><strong>-</strong></a><strong>]</strong></p>
<ul>
  <li style="text-align:justify;"><a href="https://www.it-connect.fr/tuto-installation-crowdsec-pare-feu-pfsense/#I_Presentation">I. Présentation</a></li>
  <li style="text-align:justify;"><a href="https://www.it-connect.fr/tuto-installation-crowdsec-pare-feu-pfsense/#II_Prerequis_pour_suivre_ce_tutoriel">II. Prérequis pour suivre ce tutoriel</a></li>
  <li style="text-align:justify;"><a href="https://www.it-connect.fr/tuto-installation-crowdsec-pare-feu-pfsense/#III_Installer_CrowdSec_sur_PfSense">III. Installer CrowdSec sur PfSense</a>
    <ul>
      <li style="text-align:justify;"><a href="https://www.it-connect.fr/tuto-installation-crowdsec-pare-feu-pfsense/#A_Acceder_au_shell_de_PfSense">A. Accéder au shell de PfSense</a></li>
      <li style="text-align:justify;"><a href="https://www.it-connect.fr/tuto-installation-crowdsec-pare-feu-pfsense/#B_Installer_CrowdSec_le_paquet_PfSense_et_le_bouncer_Firewall">B. Installer CrowdSec, le paquet PfSense et le bouncer Firewall</a></li>
    </ul>
  </li>
  <li style="text-align:justify;"><a href="https://www.it-connect.fr/tuto-installation-crowdsec-pare-feu-pfsense/#IV_Configurer_CrowdSec_sur_PfSense">IV. Configurer CrowdSec sur PfSense</a></li>
  <li style="text-align:justify;"><a href="https://www.it-connect.fr/tuto-installation-crowdsec-pare-feu-pfsense/#V_Simuler_un_scan_de_ports_sur_PfSense">V. Simuler un scan de ports sur PfSense</a></li>
  <li style="text-align:justify;"><a href="https://www.it-connect.fr/tuto-installation-crowdsec-pare-feu-pfsense/#VI_Conclusion">VI. Conclusion</a></li>
</ul>
<p>&nbsp;</p>
<h2 style="text-align:justify;">I. Présentation</h2>
<p style="text-align:justify;"><strong>Dans ce tutoriel, nous allons voir comment installer CrowdSec sur un pare-feu PfSense dans le but de bloquer les adresses IP malveillantes, notamment à l'origine d'attaques brute force, de scans de port et de recherche de vulnérabilités web (HTTP).</strong></p>
<p style="text-align:justify;">CrowdSec, que nous avons déjà abordé au sein de plusieurs articles, est une <strong>solution gratuite</strong> et <strong>open source</strong> capable de <strong>détecter et bloquer les attaques</strong> à destination des machines, grâce à la prise en charge de nombreux scénarios de détection. CrowdSec prend en charge Linux, Windows Server, FreeBSD, et il peut être mis en place sur certains firewalls comme PfSense et OPNSense.</p>
<p style="text-align:justify;">Lorsqu'il est en place sur un firewall PfSense, CrowdSec va analyser plusieurs journaux du système pour identifier les comportements malveillants et bloquer les adresses IP associées. En complément, les adresses IP présentes dans les listes communautaires de CrowdSec sont également bloquées.</p>
<p style="text-align:justify;">Il est important de préciser que si vous utilisez <strong>HAProxy en tant que reverse proxy sur un pare-feu PfSense</strong>, vous pouvez également<strong> configurer CrowdSec pour qu'il surveille les logs de HAProxy pour détecter les attaques Web</strong>. C'est très intéressant, et ce scénario sera probablement détaillé dans un article complémentaire.</p>
<p style="text-align:justify;">Pour vous aider à mettre en place ce tutoriel, voici quelques ressources supplémentaires :</p>
<ul>
  <li style="text-align:justify;"><a href="https://www.it-connect.fr/comment-installer-pfsense-dans-virtualbox-pour-creer-un-lab-virtuel/">Créer un lab virtuel avec VirtualBox et PfSense</a></li>
  <li style="text-align:justify;"><a href="https://www.it-connect.fr/tuto-vmware-workstation-lab-virtuel-pfsense/">Créer un lab virtuel avec VMware Workstation et PfSense</a></li>
  <li style="text-align:justify;"><a href="https://www.it-connect.fr/pfsense-reverse-proxy-https-avec-haproxy-et-acme-lets-encrypt/">Configurer un reverse proxy HAProxy sur PfSense</a></li>
  <li style="text-align:justify;"><a href="https://docs.crowdsec.net/docs/next/getting_started/install_crowdsec_pfsense/">Documentation officielle - CrowdSec</a></li>
</ul>
<h2 style="text-align:justify;">II. Prérequis pour suivre ce tutoriel</h2>
<p style="text-align:justify;"><strong>Pour suivre ce tutoriel, vous avez besoin d'un pare-feu PfSense déjà en place car nous n'allons pas voir l'installation.</strong> Pour ceux qui le souhaitent, vous pouvez utiliser le Lab basé sur VMware Workstation comme point de départ, si vous désirez vous entrainer. C'est ce que je fais pour ma part.</p>
<p style="text-align:justify;">En complément, <strong>une machine virtuelle sous Kali Linux sera utilisée pour simuler une attaque</strong> (en se positionnant côté WAN). Mais, vous pouvez directement utiliser votre hôte physique sans problème (sous Windows, vous pouvez installer l'outil Zenmap, par exemple).</p>
<figure class="image"><img src="https://www.it-connect.fr/wp-content-itc/uploads/2024/01/Schema-Lab-PfSense-VMware-Workstation-LAN-WAN-DMZ-800x450.jpg" alt="" srcset="https://www.it-connect.fr/wp-content-itc/uploads/2024/01/Schema-Lab-PfSense-VMware-Workstation-LAN-WAN-DMZ-800x450.jpg 800w, https://www.it-connect.fr/wp-content-itc/uploads/2024/01/Schema-Lab-PfSense-VMware-Workstation-LAN-WAN-DMZ-550x309.jpg 550w, https://www.it-connect.fr/wp-content-itc/uploads/2024/01/Schema-Lab-PfSense-VMware-Workstation-LAN-WAN-DMZ-150x84.jpg 150w, https://www.it-connect.fr/wp-content-itc/uploads/2024/01/Schema-Lab-PfSense-VMware-Workstation-LAN-WAN-DMZ-768x432.jpg 768w, https://www.it-connect.fr/wp-content-itc/uploads/2024/01/Schema-Lab-PfSense-VMware-Workstation-LAN-WAN-DMZ-50x28.jpg 50w, https://www.it-connect.fr/wp-content-itc/uploads/2024/01/Schema-Lab-PfSense-VMware-Workstation-LAN-WAN-DMZ.jpg 1200w" sizes="100vw" width="800"></figure>
<h2 style="text-align:justify;">III. Installer CrowdSec sur PfSense</h2>
<h3 style="text-align:justify;">A. Accéder au shell de PfSense</h3>
<p style="text-align:justify;">La première étape consiste à installer un ensemble de paquets sur le pare-feu PfSense afin de pouvoir intégrer CrowdSec. Pour exécuter des commandes shell sur PfSense, il y a trois options :</p>
<ul>
  <li style="text-align:justify;">Utiliser le <strong>mode console</strong> (via l'hyperviseur, par exemple)</li>
  <li style="text-align:justify;">Utiliser la <strong>console distante</strong> via une connexion <strong>SSH</strong></li>
  <li style="text-align:justify;">Utiliser la fonction "<strong>Command Prompt</strong>" accessible via l'interface web de PfSense (dans le menu "<strong>Diagnostics</strong>").</li>
</ul>
<p style="text-align:justify;">Dans le cas présent, je pensais utiliser la fonction "<strong>Command Prompt</strong>" mais les commandes ne sont pas passées. Il est préférable de passer directement via la console.</p>
<figure class="image"><img src="https://www.it-connect.fr/wp-content-itc/uploads/2024/02/PfSense-Menu-Diagnostique-commandes-800x335.png" alt="PfSense - Menu Diagnostique commandes" srcset="https://www.it-connect.fr/wp-content-itc/uploads/2024/02/PfSense-Menu-Diagnostique-commandes-800x335.png 800w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/PfSense-Menu-Diagnostique-commandes-550x231.png 550w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/PfSense-Menu-Diagnostique-commandes-150x63.png 150w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/PfSense-Menu-Diagnostique-commandes-768x322.png 768w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/PfSense-Menu-Diagnostique-commandes-50x21.png 50w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/PfSense-Menu-Diagnostique-commandes.png 835w" sizes="100vw" width="800"></figure>
<p style="text-align:justify;">Si vous avez besoin d'activer le SSH, cliquez sur "<strong>System</strong>" puis "<strong>Advanced</strong>". À cet endroit, il y a une section "<strong>Secure Shell</strong>" où vous pouvez activer le SSH et <strong>définir un port personnalisé</strong>.</p>
<figure class="image"><img src="https://www.it-connect.fr/wp-content-itc/uploads/2024/02/PfSense-Activer-acces-SSH.png" alt="PfSense - Activer accès SSH" srcset="https://www.it-connect.fr/wp-content-itc/uploads/2024/02/PfSense-Activer-acces-SSH.png 800w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/PfSense-Activer-acces-SSH-550x213.png 550w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/PfSense-Activer-acces-SSH-150x58.png 150w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/PfSense-Activer-acces-SSH-768x298.png 768w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/PfSense-Activer-acces-SSH-50x19.png 50w" sizes="100vw" width="800"></figure>
<p style="text-align:justify;">Ensuite, vous devez vous connecter en SSH à PfSense. Vous pouvez utiliser le client OpenSSH de Windows ou Linux, ou une autre application telle que PuTTY.</p>
<p style="text-align:justify;">Voici comment se connecter sur un pare-feu avec l'adresse IP "<strong>192.168.100.1</strong>" avec le compte "<strong>admin</strong>", où le port SSH est <strong>9922</strong>.</p>
<pre><code class="language-plaintext">ssh admin@192.168.100.1 -p 9922</code></pre>
<p style="text-align:justify;">La première fois, vous devez accepter l'empreinte en indiquant "<strong>yes</strong>". Ensuite, saisissez le mot de passe et validez. Pour accéder au shell, choisissez l'option "<strong>8</strong>".</p>
<figure class="image"><img src="https://www.it-connect.fr/wp-content-itc/uploads/2024/02/Se-connecter-en-SSH-sur-PfSense-800x527.png" alt="" srcset="https://www.it-connect.fr/wp-content-itc/uploads/2024/02/Se-connecter-en-SSH-sur-PfSense-800x527.png 800w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/Se-connecter-en-SSH-sur-PfSense-550x362.png 550w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/Se-connecter-en-SSH-sur-PfSense-150x99.png 150w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/Se-connecter-en-SSH-sur-PfSense-768x506.png 768w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/Se-connecter-en-SSH-sur-PfSense-50x33.png 50w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/Se-connecter-en-SSH-sur-PfSense.png 850w" sizes="100vw" width="800"></figure>
<h3 style="text-align:justify;">B. Installer CrowdSec, le paquet PfSense et le bouncer Firewall</h3>
<p style="text-align:justify;">Désormais, il va falloir<strong> installer CrowdSec, son paquet pour PfSense, le bouncer Firewall et des dépendances</strong>.</p>
<p style="text-align:justify;">Pour cela, vous devez récupérer les liens vers les dernières versions en vous référant au GitHub de CrowdSec. Autrement dit, les commandes "pkg add" ci-dessous pointent vers les versions actuelles, mais ce ne seront pas forcément les dernières lorsque vous allez suivre ce tutoriel.</p>
<ul>
  <li style="text-align:justify;"><a href="https://github.com/crowdsecurity/pfSense-pkg-crowdsec/releases">GitHub - CrowdSec pour PfSense</a></li>
</ul>
<p style="text-align:justify;">Avant d'installer les paquets, nous allons définir la variable "IGNORE_OSVERSION" à "yes" pour éviter les avertissements lors de l'installation des paquets (dû à la différence entre la version du paquet et la version de FreeBSD sur laquelle est basée PfSense).</p>
<p style="text-align:justify;">Dans la console, saisissez cette commande :</p>
<pre><code class="language-plaintext">setenv IGNORE_OSVERSION yes</code></pre>
<p style="text-align:justify;">Puis exécutez les commandes suivantes pour télécharger et installer les paquets :</p>
<pre><code class="language-plaintext">pkg add -f https://github.com/crowdsecurity/pfSense-pkg-crowdsec/releases/download/v0.1.3/abseil-20230125.3.pkg
pkg add -f https://github.com/crowdsecurity/pfSense-pkg-crowdsec/releases/download/v0.1.3/re2-20231101.pkg
pkg add -f https://github.com/crowdsecurity/pfSense-pkg-crowdsec/releases/download/v0.1.3/crowdsec-1.6.0.pkg
pkg add -f https://github.com/crowdsecurity/pfSense-pkg-crowdsec/releases/download/v0.1.3/crowdsec-firewall-bouncer-0.0.28_3.pkg
pkg add -f https://github.com/crowdsecurity/pfSense-pkg-crowdsec/releases/download/v0.1.3/pfSense-pkg-crowdsec-0.1.3.pkg</code></pre>
<p>&nbsp;</p>
<figure class="image"><img src="https://www.it-connect.fr/wp-content-itc/uploads/2024/02/install-crowdsec-pfsense-800x210.jpg" alt="install crowdsec pfsense" srcset="https://www.it-connect.fr/wp-content-itc/uploads/2024/02/install-crowdsec-pfsense-800x210.jpg 800w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/install-crowdsec-pfsense-550x145.jpg 550w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/install-crowdsec-pfsense-150x39.jpg 150w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/install-crowdsec-pfsense-768x202.jpg 768w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/install-crowdsec-pfsense-50x13.jpg 50w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/install-crowdsec-pfsense.jpg 1000w" sizes="100vw" width="800"></figure>
<p style="text-align:justify;">L'installation de CrowdSec est effectuée à l'emplacement suivant :</p>
<pre><code class="language-plaintext">/usr/local/etc/crowdsec/</code></pre>
<p style="text-align:justify;">Par la suite, si vous avez besoin de redémarrer CrowdSec, utilisez cette commande (adaptez également pour l'arrêter / le démarrer) :</p>
<pre><code class="language-plaintext">service crowdsec.sh restart</code></pre>
<p style="text-align:justify;">Avant de poursuivre, <strong>vous devez redémarrer votre pare-feu PfSense</strong>, sinon CrowdSec ne sera pas actif, et la ligne de commande "cscli" indisponible également.</p>
<p style="text-align:justify;"><strong>Voilà, vous venez d'installer CrowdSec sur PfSense !</strong></p>
<h2 style="text-align:justify;">IV. Configurer CrowdSec sur PfSense</h2>
<p style="text-align:justify;">Sachez que tout le jeu de commandes habituel permettant de configurer et d'utiliser CrowdSec est disponible : <strong>cscli</strong>. Vous pouvez aussi faire l'essentiel de la configuration à partir de l'interface d'administration de PfSense.</p>
<p style="text-align:justify;">À partir du menu, sous "<strong>Services</strong>", choisissez "<strong>CrowdSec</strong>".</p>
<figure class="image"><img src="https://www.it-connect.fr/wp-content-itc/uploads/2024/02/PfSense-Menu-Services-CrowdSec.png" alt="PfSense - Menu Services CrowdSec" srcset="https://www.it-connect.fr/wp-content-itc/uploads/2024/02/PfSense-Menu-Services-CrowdSec.png 800w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/PfSense-Menu-Services-CrowdSec-550x144.png 550w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/PfSense-Menu-Services-CrowdSec-150x39.png 150w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/PfSense-Menu-Services-CrowdSec-768x202.png 768w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/PfSense-Menu-Services-CrowdSec-50x13.png 50w" sizes="100vw" width="800"></figure>
<p style="text-align:justify;">Par défaut, et c'est plutôt appréciable, CrowdSec est préconfiguré pour être opérationnel et être capable d'analyser les journaux de PfSense. Pour en savoir plus sur les fichiers de logs parsés par CrowdSec, regardez ces deux fichiers :</p>
<pre><code class="language-plaintext">/usr/local/etc/crowdsec/acquis.yaml
/usr/local/etc/crowdsec/acquis.d/pfsense.yaml</code></pre>
<p style="text-align:justify;">Vous devez tout de même réviser la configuration proposée...</p>
<figure class="image"><img src="https://www.it-connect.fr/wp-content-itc/uploads/2024/02/Configurer-CrowdSec-sur-PfSense-Etape-1-800x376.png" alt="Configurer CrowdSec sur PfSense - Etape 1" srcset="https://www.it-connect.fr/wp-content-itc/uploads/2024/02/Configurer-CrowdSec-sur-PfSense-Etape-1-800x376.png 800w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/Configurer-CrowdSec-sur-PfSense-Etape-1-550x259.png 550w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/Configurer-CrowdSec-sur-PfSense-Etape-1-150x71.png 150w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/Configurer-CrowdSec-sur-PfSense-Etape-1-768x361.png 768w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/Configurer-CrowdSec-sur-PfSense-Etape-1-50x24.png 50w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/Configurer-CrowdSec-sur-PfSense-Etape-1.png 850w" sizes="100vw" width="800"></figure>
<p style="text-align:justify;">Vous pouvez constater que la "<strong>Local API</strong>" (LAPI) est activée. Elle est utilisée par CrowdSec pour le partage d'informations entre plusieurs instances. Ici, c'est en local. Au cas où il s'agirait d'un déploiement avec plusieurs machines qui s'échangent les informations (adresses IP bloquées, par exemple), il faudrait s'intéresser à la section "<strong>Remote API</strong>". Ici, ce n'est pas nécessaire.</p>
<figure class="image"><img src="https://www.it-connect.fr/wp-content-itc/uploads/2024/02/Configurer-CrowdSec-sur-PfSense-Etape-2-800x367.png" alt="Configurer CrowdSec sur PfSense - Etape 2" srcset="https://www.it-connect.fr/wp-content-itc/uploads/2024/02/Configurer-CrowdSec-sur-PfSense-Etape-2-800x367.png 800w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/Configurer-CrowdSec-sur-PfSense-Etape-2-550x253.png 550w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/Configurer-CrowdSec-sur-PfSense-Etape-2-150x69.png 150w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/Configurer-CrowdSec-sur-PfSense-Etape-2-768x353.png 768w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/Configurer-CrowdSec-sur-PfSense-Etape-2-50x23.png 50w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/Configurer-CrowdSec-sur-PfSense-Etape-2.png 930w" sizes="100vw" width="800"></figure>
<p style="text-align:justify;">Descendez dans la page... Nous pouvons constater que CrowdSec est actif sur toutes les interfaces de PfSense, en entrée (flux malveillants entrants). Il est important de préciser que<strong> les règles de pare-feu créées par CrowdSec ne sont pas visibles dans la liste des règles de PfSense que l'on peut afficher en mode web</strong>, mais uniquement en ligne de commande.</p>
<figure class="image"><img src="https://www.it-connect.fr/wp-content-itc/uploads/2024/02/Configurer-CrowdSec-sur-PfSense-Etape-3-800x341.png" alt="Configurer CrowdSec sur PfSense - Etape 3" srcset="https://www.it-connect.fr/wp-content-itc/uploads/2024/02/Configurer-CrowdSec-sur-PfSense-Etape-3-800x341.png 800w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/Configurer-CrowdSec-sur-PfSense-Etape-3-550x234.png 550w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/Configurer-CrowdSec-sur-PfSense-Etape-3-150x64.png 150w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/Configurer-CrowdSec-sur-PfSense-Etape-3-768x327.png 768w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/Configurer-CrowdSec-sur-PfSense-Etape-3-50x21.png 50w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/Configurer-CrowdSec-sur-PfSense-Etape-3.png 1153w" sizes="100vw" width="800"></figure>
<p style="text-align:justify;">Cliquez sur le bouton "<strong>Save</strong>" pour valider la configuration et démarrer CrowdSec.</p>
<figure class="image"><img src="https://www.it-connect.fr/wp-content-itc/uploads/2024/02/Configurer-CrowdSec-sur-PfSense-Premier-demarrage-800x394.png" alt="" srcset="https://www.it-connect.fr/wp-content-itc/uploads/2024/02/Configurer-CrowdSec-sur-PfSense-Premier-demarrage-800x394.png 800w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/Configurer-CrowdSec-sur-PfSense-Premier-demarrage-550x271.png 550w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/Configurer-CrowdSec-sur-PfSense-Premier-demarrage-150x74.png 150w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/Configurer-CrowdSec-sur-PfSense-Premier-demarrage-768x378.png 768w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/Configurer-CrowdSec-sur-PfSense-Premier-demarrage-50x25.png 50w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/Configurer-CrowdSec-sur-PfSense-Premier-demarrage.png 986w" sizes="100vw" width="800"></figure>
<p style="text-align:justify;">Désormais, dans le menu "<strong>Status</strong>", cliquez sur "<strong>CrowdSec Status</strong>".</p>
<figure class="image"><img src="https://www.it-connect.fr/wp-content-itc/uploads/2024/02/Configurer-CrowdSec-sur-PfSense-Etape-4-800x335.png" alt="Configurer CrowdSec sur PfSense - Etape 4" srcset="https://www.it-connect.fr/wp-content-itc/uploads/2024/02/Configurer-CrowdSec-sur-PfSense-Etape-4-800x335.png 800w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/Configurer-CrowdSec-sur-PfSense-Etape-4-550x230.png 550w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/Configurer-CrowdSec-sur-PfSense-Etape-4-150x63.png 150w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/Configurer-CrowdSec-sur-PfSense-Etape-4-768x321.png 768w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/Configurer-CrowdSec-sur-PfSense-Etape-4-50x21.png 50w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/Configurer-CrowdSec-sur-PfSense-Etape-4.png 1166w" sizes="100vw" width="800"></figure>
<p style="text-align:justify;">Ici, vous pouvez visualiser l'<strong>état général de CrowdSec</strong>, ainsi qu'obtenir la liste des <strong>bouncers</strong>, des <strong>collections</strong>, des <strong>scénarios</strong>, etc... Mais aussi lister les dernières alertes et les décisions. Pour rappel, une décision correspond au fait de <strong>bannir une adresse IP</strong> (action par défaut).</p>
<figure class="image"><img src="https://www.it-connect.fr/wp-content-itc/uploads/2024/02/PfSense-CrowdSec-Status-800x283.png" alt="" srcset="https://www.it-connect.fr/wp-content-itc/uploads/2024/02/PfSense-CrowdSec-Status-800x283.png 800w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/PfSense-CrowdSec-Status-550x194.png 550w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/PfSense-CrowdSec-Status-150x53.png 150w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/PfSense-CrowdSec-Status-768x271.png 768w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/PfSense-CrowdSec-Status-50x18.png 50w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/PfSense-CrowdSec-Status.png 1158w" sizes="100vw" width="800"></figure>
<p style="text-align:justify;">Voici la liste des collections actuellement installées :</p>
<figure class="image"><img src="https://www.it-connect.fr/wp-content-itc/uploads/2024/02/CrowdSec-Liste-des-collections-PfSense-800x356.png" alt="" srcset="https://www.it-connect.fr/wp-content-itc/uploads/2024/02/CrowdSec-Liste-des-collections-PfSense-800x356.png 800w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/CrowdSec-Liste-des-collections-PfSense-550x245.png 550w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/CrowdSec-Liste-des-collections-PfSense-150x67.png 150w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/CrowdSec-Liste-des-collections-PfSense-768x342.png 768w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/CrowdSec-Liste-des-collections-PfSense-50x22.png 50w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/CrowdSec-Liste-des-collections-PfSense.png 1142w" sizes="100vw" width="800"></figure>
<p style="text-align:justify;">Nous pourrions en ajouter d'autres à partir de la ligne de commande (<i>cscli collections install</i>). Ceci peut s'avérer utile si votre pare-feu PfSense héberge d'autres services, comme un reverse proxy HAProxy, par exemple.</p>
<p style="text-align:justify;">Enfin, il y a la section "<strong>CrowdSec Metrics</strong>" accessible via le menu "<strong>Diagnostics</strong>" de PfSense qui donne des statistiques plus détaillées sur l'activité de CrowdSec sur notre pare-feu. Nous pouvons entre autres visualiser quels sont les fichiers de log analysés par CrowdSec et obtenir des statistiques à leur sujet.</p>
<figure class="image"><img src="https://www.it-connect.fr/wp-content-itc/uploads/2024/02/PfSense-CrowdSec-Metrics-800x290.png" alt="PfSense - CrowdSec Metrics" srcset="https://www.it-connect.fr/wp-content-itc/uploads/2024/02/PfSense-CrowdSec-Metrics-800x290.png 800w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/PfSense-CrowdSec-Metrics-550x200.png 550w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/PfSense-CrowdSec-Metrics-150x54.png 150w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/PfSense-CrowdSec-Metrics-768x279.png 768w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/PfSense-CrowdSec-Metrics-50x18.png 50w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/PfSense-CrowdSec-Metrics.png 1157w" sizes="100vw" width="800"></figure>
<h2 style="text-align:justify;">V. Simuler un scan de ports sur PfSense</h2>
<p style="text-align:justify;">A partir de l'<strong>outil NMAP</strong>, nous allons pouvoir <strong>réaliser un scan de ports sur l'adresse IP de l'interface WAN du PfSense</strong>. Dans cet exemple, il s'agit de "1<strong>92.168.1.60</strong>", mais en production, il s'agirait de votre adresse IP publique. Vous pouvez utiliser NMAP sur Linux, via WSL, ou sinon en mode graphique sous Windows avec Zenmap.</p>
<p style="text-align:justify;">Voici la commande à exécuter pour faire un scan de port à la recherche de services fréquents :</p>
<pre><code class="language-plaintext">nmap -sV 192.168.1.60</code></pre>
<p style="text-align:justify;">Le scan a permis de détecter que le <strong>port 80/tcp (http) </strong>était ouvert. C'est normal, car une règle de NAT redirige les flux HTTP vers un serveur Web en DMZ. Il n'a pas obtenu d'autres réponses.</p>
<figure class="image"><img src="https://www.it-connect.fr/wp-content-itc/uploads/2024/02/Scan-de-port-avec-nmap-Exemple.png" alt="Scan de port avec nmap - Exemple" srcset="https://www.it-connect.fr/wp-content-itc/uploads/2024/02/Scan-de-port-avec-nmap-Exemple.png 800w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/Scan-de-port-avec-nmap-Exemple-550x138.png 550w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/Scan-de-port-avec-nmap-Exemple-150x38.png 150w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/Scan-de-port-avec-nmap-Exemple-768x192.png 768w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/Scan-de-port-avec-nmap-Exemple-50x13.png 50w" sizes="100vw" width="800"></figure>
<p style="text-align:justify;">Pour cause, la machine à l'origine du scan a été bannie par CrowdSec. Nous pouvons le voir dans le menu "<strong>Status</strong>" puis "<strong>CrowdSec</strong>", en accédant à l'onglet "<strong>Decisions</strong>". Cette adresse IP a été bannie à cause du scan de port, comme indiqué : <strong>pf-scan-multi_ports</strong>.</p>
<figure class="image"><img src="https://www.it-connect.fr/wp-content-itc/uploads/2024/02/PfSense-Adresse-IP-bannie-par-CrowdSec-800x308.png" alt="PfSense - Adresse IP bannie par CrowdSec" srcset="https://www.it-connect.fr/wp-content-itc/uploads/2024/02/PfSense-Adresse-IP-bannie-par-CrowdSec-800x308.png 800w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/PfSense-Adresse-IP-bannie-par-CrowdSec-550x212.png 550w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/PfSense-Adresse-IP-bannie-par-CrowdSec-150x58.png 150w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/PfSense-Adresse-IP-bannie-par-CrowdSec-768x296.png 768w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/PfSense-Adresse-IP-bannie-par-CrowdSec-50x19.png 50w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/PfSense-Adresse-IP-bannie-par-CrowdSec.png 1137w" sizes="100vw" width="800"></figure>
<p style="text-align:justify;">L'information est bien entendu visible à partir de la ligne de commande :</p>
<pre><code class="language-plaintext">cscli decisions list </code></pre>
<figure class="image"><img src="https://www.it-connect.fr/wp-content-itc/uploads/2024/02/PfSense-Exemple-de-cscli.jpg" alt="PfSense - Exemple de cscli" srcset="https://www.it-connect.fr/wp-content-itc/uploads/2024/02/PfSense-Exemple-de-cscli.jpg 800w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/PfSense-Exemple-de-cscli-550x60.jpg 550w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/PfSense-Exemple-de-cscli-150x16.jpg 150w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/PfSense-Exemple-de-cscli-768x84.jpg 768w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/PfSense-Exemple-de-cscli-50x5.jpg 50w" sizes="100vw" width="800"></figure>
<p style="text-align:justify;">Nous pouvons constater que CrowdSec est opérationnel et réactif sur notre pare-feu PfSense ! C'est un gros plus pour la protection de notre réseau !</p>
<h2 style="text-align:justify;">VI. Conclusion</h2>
<p style="text-align:justify;">Suite à la mise en place de CrowdSec sur notre pare-feu PfSense, nous sommes en mesure de détecter et bloquer les adresses IP malveillantes. Ainsi, si une machine vient frapper à la porte de votre pare-feu pour voir quels sont les services ouverts, elle sera directement bannie.</p>
<p style="text-align:justify;">Par la suite, nous verrons comment aller plus loin dans la détection et la configuration s'il y a un reverse proxy HAProxy en place sur le pare-feu PfSense. Pour aller plus loin, nous pourrions aussi déployer CrowdSec sur les serveurs de notre infrastructure et faire en sorte pour que toutes les décisions et alertes soient synchronisées entre les hôtes, en nous appuyant sur l'instance CrowdSec déployée sur PfSense comme point central.</p>
<h1>Install sur Windows</h1>
<p><a href="https://www.it-connect.fr/comment-securiser-un-serveur-windows-avec-crowdsec/">Installer CrowdSec sur Windows Server</a></p>
<h1>Infra CowdSec sur les vm en liaison avec le serveur installé sur PFSense</h1>
<h2>I. Présentation</h2>
<p><strong>Dans ce tutoriel, nous allons voir comment effectuer une installation de CrowdSec sur plusieurs machines afin de répliquer les alertes et les décisions entre les différentes instances. Ainsi, lorsqu'un serveur banni une adresse IP, elle est également bannie sur les autres instances CrowdSec synchronisées.</strong></p>
<p>Pour effectuer une installation multiserveur de CrowdSec, toutes les machines doivent avoir une instance CrowdSec installée en local. Ensuite, nous viendrons ajuster la configuration de chaque instance, notamment au niveau de LAPI. Si vous avez <strong>plusieurs serveurs exposés sur Internet</strong> (un cluster de serveurs Web, par exemple), vous pouvez<strong> déployer cette configuration</strong> pour que <strong>les adresses IP malveillantes soient bannies sur tous les nœuds</strong>.</p>
<p><strong>Pour les échanges d'informations, CrowdSec s'appuie sur deux API :</strong></p>
<ul>
  <li><strong>Local API ou LAPI</strong> : ceci correspond à l'hôte local lorsque l'instance CrowdSec fonctionne de façon autonome</li>
  <li><strong>Cloud API ou CAPI</strong> : ceci correspond aux instances CrowdSec dans le Cloud, notamment sollicitées pour récupérer les listes d'adresses IP malveillantes communautaires et pour transmettre les signaux à la <a href="https://www.it-connect.fr/surveillez-les-cybermenaces-sur-vos-serveurs-avec-la-console-crowdsec/">console CrowdSec</a>.</li>
</ul>
<h2>II. Architecture avec un pare-feu PfSense et des serveurs virtuels</h2>
<p>Pour le déploiement, plusieurs scénarios sont envisageables. Vous pouvez utiliser <strong>une machine CrowdSec destinée à centraliser toutes les décisions et toutes les alertes</strong>, et sur laquelle les autres machines viendront se synchroniser. Il est d'ailleurs possible de s'appuyer sur une base de données, pour des questions de performance.</p>
<p>Aujourd'hui, nous allons déployer un scénario basé sur deux machines :</p>
<ul>
  <li>Un pare-feu PfSense, où CrowdSec sera installé et cet hôte sera utilisé pour héberger le rôle de "Local API" pour les trois machines</li>
  <li>Un serveur Windows Server, où CrowdSec sera installé avec le bouncer windows-firewall</li>
</ul>
<p>Ici, il n'y a qu'un seul serveur exposé sur Internet, représenté par un serveur Web sous Windows Server, mais il pourrait tout à fait en avoir d'autres (y compris sous Linux). Je vais vous préciser les étapes à effectuer sur les noeuds que l'on pourrait appeler les "clients LAPI".</p>
<figure class="image"><img src="https://www.it-connect.fr/wp-content-itc/uploads/2024/02/CrowdSec-multi-server-PfSense-Linux-Windows-Server-800x496.png" alt="CrowdSec multi-server PfSense Linux Windows Server" srcset="https://www.it-connect.fr/wp-content-itc/uploads/2024/02/CrowdSec-multi-server-PfSense-Linux-Windows-Server-800x496.png 800w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/CrowdSec-multi-server-PfSense-Linux-Windows-Server-550x341.png 550w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/CrowdSec-multi-server-PfSense-Linux-Windows-Server-150x93.png 150w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/CrowdSec-multi-server-PfSense-Linux-Windows-Server-768x476.png 768w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/CrowdSec-multi-server-PfSense-Linux-Windows-Server-50x31.png 50w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/CrowdSec-multi-server-PfSense-Linux-Windows-Server.png 816w" sizes="100vw" width="800"></figure>
<p><strong>Remarque&nbsp;</strong>: dans la vidéo,<strong> le scénario est basé sur trois machines</strong>, avec un second serveur en DMZ, sous <strong>Linux</strong>, lui aussi serveur Web et exposé sur Internet également. Référez-vous à la vidéo si nécessaire, selon vos besoins.</p>
<h2>III. Point de départ</h2>
<p>Ce tutoriel n'abordera pas l'installation de CrowdSec sur les différents hôtes, ni même l'installation des systèmes d'exploitation. Pour cela, référez-vous aux articles suivants :</p>
<ul>
  <li><a href="https://www.it-connect.fr/comment-securiser-un-serveur-windows-avec-crowdsec/">Installer CrowdSec sur Windows Server</a></li>
  <li><a href="https://www.it-connect.fr/tuto-installation-crowdsec-pare-feu-pfsense/">Installer CrowdSec sur PfSense</a></li>
  <li><a href="https://www.it-connect.fr/comment-installer-pfsense-dans-virtualbox-pour-creer-un-lab-virtuel/">Créer un lab virtuel avec VirtualBox et PfSense</a></li>
  <li><a href="https://www.it-connect.fr/tuto-vmware-workstation-lab-virtuel-pfsense/">Créer un lab virtuel avec VMware Workstation et PfSense</a></li>
</ul>
<p>Quand votre environnement est prêt, vous pouvez passer à la phase de configuration.</p>
<h2>IV. Configurer le serveur LAPI central pour CrowdSec</h2>
<p>Sur le pare-feu PfSense, nous devons <strong>configurer CrowdSec pour qu'il soit en écoute sur une adresse IP du pare-feu</strong>, afin de ne pas être accessible uniquement en local. Sans cela, les autres hôtes ne pourront pas venir s'inscrire sur ce serveur LAPI car par défaut l'hôte LAPI est configuré sur l'adresse IP de boucle locale : 127.0.0.1.</p>
<p>Connectez-vous à l'interface d'administration de PfSense, cliquez sur "<strong>Services</strong>" puis "<strong>CrowdSec</strong>". Ici, descendez jusqu'à trouver l'option "<strong>LAPI host</strong>" et remplacez "<strong>127.0.0.1</strong>" par le nom d'hôte (DNS) de votre pare-feu PfSense, ou l'adresse IP de l'une de ses interfaces. Dans cet exemple, je précise "<strong>192.168.200.1</strong>" car il s'agit de l'adresse IP de l'interface "<strong>DMZ</strong>" de mon pare-feu et le serveur Web se situe dans cette zone réseau.</p>
<figure class="image"><img src="https://www.it-connect.fr/wp-content-itc/uploads/2024/02/CrowdSec-PfSense-en-tant-que-serveur-LAPI-800x296.png" alt="CrowdSec - PfSense en tant que serveur LAPI" srcset="https://www.it-connect.fr/wp-content-itc/uploads/2024/02/CrowdSec-PfSense-en-tant-que-serveur-LAPI-800x296.png 800w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/CrowdSec-PfSense-en-tant-que-serveur-LAPI-550x203.png 550w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/CrowdSec-PfSense-en-tant-que-serveur-LAPI-150x55.png 150w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/CrowdSec-PfSense-en-tant-que-serveur-LAPI-768x284.png 768w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/CrowdSec-PfSense-en-tant-que-serveur-LAPI-50x18.png 50w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/CrowdSec-PfSense-en-tant-que-serveur-LAPI.png 1158w" sizes="100vw" width="800"></figure>
<p>Quand c'est fait, sauvegardez la configuration avec le bouton prévu à cet effet.</p>
<p>Il est à noter que cette modification, bien qu'elle soit effectuée via l'interface web de PfSense, pourrait être effectuée en ligne de commande en modifiant le fichier suivant :</p>
<pre><code class="language-plaintext">/usr/local/etc/crowdsec/config.yaml</code></pre>
<p>D'ailleurs, ce que nous venons d'effectuer en mode web a permis de modifier le fichier de configuration.</p>
<figure class="image"><img src="https://www.it-connect.fr/wp-content-itc/uploads/2024/02/CrowdSec-sur-PfSense-LAPI-en-ecoute-sur-adresse-IP.png" srcset="https://www.it-connect.fr/wp-content-itc/uploads/2024/02/CrowdSec-sur-PfSense-LAPI-en-ecoute-sur-adresse-IP.png 800w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/CrowdSec-sur-PfSense-LAPI-en-ecoute-sur-adresse-IP-550x199.png 550w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/CrowdSec-sur-PfSense-LAPI-en-ecoute-sur-adresse-IP-150x54.png 150w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/CrowdSec-sur-PfSense-LAPI-en-ecoute-sur-adresse-IP-768x278.png 768w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/CrowdSec-sur-PfSense-LAPI-en-ecoute-sur-adresse-IP-50x18.png 50w" sizes="100vw" width="800"></figure>
<p>Passez à l'étape suivante.</p>
<h2>V. Inscrire et autoriser les hôtes sur le serveur LAPI</h2>
<p>Le serveur Web sous Windows Server va devoir <strong>s'inscrire sur le serveur LAPI CrowdSec</strong>, c'est-à-dire notre pare-feu PfSense. Ensuite, nous devrons <strong>approuver la demande d'inscription</strong>. Cette étape est à effectuer sur chaque serveur qui doit utiliser le serveur LAPI central.</p>
<h3>A. Désactiver l'interface LAPI de CrowdSec</h3>
<p>À partir du serveur Windows Server, où CrowdSec est installé, vous devez commencer par modifier le fichier de configuration "<strong>config.yaml</strong>" situé à cet emplacement :</p>
<pre><code class="language-plaintext">C:\ProgramData\CrowdSec\config\</code></pre>
<p>Dans ce fichier, vous devez ajouter la ligne "<strong>enable: false</strong>" sous "<strong>server:</strong>", et commenter la ligne "<strong>listen_uri</strong>" afin de <strong>désactiver la LAPI de CrowdSec</strong>. En effet, ce n'est plus utile sur ce serveur puisque nous allons solliciter la LAPI de l'instance CrowdSec installée sur le pare-feu PfSense.</p>
<p>Attention à la syntaxe, notamment aux espaces, car YAML est très pointilleux là-dessus.</p>
<figure class="image"><img src="https://www.it-connect.fr/wp-content-itc/uploads/2024/02/Windows-Server-CrowdSec-Declarer-serveur-LAPI-distant.png" alt="Windows Server - CrowdSec - Déclarer serveur LAPI distant" srcset="https://www.it-connect.fr/wp-content-itc/uploads/2024/02/Windows-Server-CrowdSec-Declarer-serveur-LAPI-distant.png 800w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/Windows-Server-CrowdSec-Declarer-serveur-LAPI-distant-550x365.png 550w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/Windows-Server-CrowdSec-Declarer-serveur-LAPI-distant-150x100.png 150w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/Windows-Server-CrowdSec-Declarer-serveur-LAPI-distant-768x510.png 768w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/Windows-Server-CrowdSec-Declarer-serveur-LAPI-distant-50x33.png 50w" sizes="100vw" width="800"></figure>
<p>Une fois que c'est fait, sauvegardez le fichier.</p>
<ul>
  <li><a href="https://docs.crowdsec.net/docs/configuration/crowdsec_configuration/">CrowdSec - Documentation - Fichier de configuration</a></li>
</ul>
<h3>B. Inscrire les hôtes CrowdSec sur le serveur LAPI</h3>
<p><strong>Toujours sur ce même serveur</strong>, ouvrez une console <strong>PowerShell &nbsp;</strong>ou une<strong> Invite de commande&nbsp;</strong>afin d'inscrire l'hôte sur le serveur LAPI. Exécutez la commande suivante, en adaptant l'adresse IP (et éventuellement le port, si vous l'avez modifié).</p>
<pre><code class="language-plaintext">cscli lapi register -u&nbsp; http://192.168.200.1:8080</code></pre>
<p>Si l'on ne précise pas de nom, comme c'est le cas avec la commande ci-dessus, <strong>un ID aléatoire sera généré</strong>. Si vous souhaitez préciser un nom, afin que ce soit plus parlant, utilisez la commande de cette façon :</p>
<pre><code class="language-plaintext">cscli lapi register -u&nbsp; http://192.168.200.1:8080&nbsp;</code></pre>
<p>Vous devez obtenir un résultat semblable à celui-ci :</p>
<figure class="image"><img src="https://www.it-connect.fr/wp-content-itc/uploads/2024/02/Windows-Server-CrowdSec-Exemple-cscli-lapi-register.jpg" alt="Windows Server - CrowdSec - Exemple cscli lapi register" srcset="https://www.it-connect.fr/wp-content-itc/uploads/2024/02/Windows-Server-CrowdSec-Exemple-cscli-lapi-register.jpg 800w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/Windows-Server-CrowdSec-Exemple-cscli-lapi-register-550x86.jpg 550w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/Windows-Server-CrowdSec-Exemple-cscli-lapi-register-150x23.jpg 150w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/Windows-Server-CrowdSec-Exemple-cscli-lapi-register-768x120.jpg 768w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/Windows-Server-CrowdSec-Exemple-cscli-lapi-register-50x8.jpg 50w" sizes="100vw" width="800"></figure>
<p>Passez à la suite.</p>
<h2>VI. Déclarer les nouveaux bouncers</h2>
<h3>A. Ajouter un bouncer et obtenir une clé d'API</h3>
<p>Toujours sur le serveur LAPI, à savoir PfSense, nous allons devoir <strong>déclarer la machine distante comme étant un bouncer</strong>. Ceci signifie qu'elle aura la permission de venir déclarer de nouvelles alertes et décisions pour bloquer des adresses IP malveillantes.</p>
<p>La commande suivante permet de déclarer un bouncer nommé "SRV-WS2022". Vous pouvez reprendre le nom d'hôte de votre machine.</p>
<pre><code class="language-plaintext">cscli bouncers add&nbsp;</code></pre>
<p>&nbsp;</p>
<pre><code class="language-plaintext">cscli bouncers add&nbsp;</code></pre>
<p>Comme le montre l'image ci-dessous, nous obtenons une clé d'API pour cet hôte :</p>
<figure class="image"><img src="https://www.it-connect.fr/wp-content-itc/uploads/2024/02/CrowdSec-Declarer-un-hote-en-tant-que-bouncer.png" alt="CrowdSec - Déclarer un hôte en tant que bouncer" srcset="https://www.it-connect.fr/wp-content-itc/uploads/2024/02/CrowdSec-Declarer-un-hote-en-tant-que-bouncer.png 800w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/CrowdSec-Declarer-un-hote-en-tant-que-bouncer-550x98.png 550w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/CrowdSec-Declarer-un-hote-en-tant-que-bouncer-150x27.png 150w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/CrowdSec-Declarer-un-hote-en-tant-que-bouncer-768x136.png 768w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/CrowdSec-Declarer-un-hote-en-tant-que-bouncer-50x9.png 50w" sizes="100vw" width="800"></figure>
<p>Cette clé d'API va lui permettre de s'authentifier sur le serveur LAPI en tant que bouncer.</p>
<h3>B. Configurer le bouncer sur l'hôte</h3>
<p>Retournez sur le serveur distant. Pour ma part, c'est le serveur Web sous Windows Server. L'objectif va être de <strong>configurer le bouncer Windows Firewall&nbsp;</strong>installé sur cette machine pour qu'il déclare les décisions sur le serveur LAPI central, plutôt qu'en local. Ceci implique d'installer le bouncer sur le serveur, au préalable.</p>
<p><strong>Éditez le fichier suivant :</strong></p>
<pre><code class="language-plaintext">C:\ProgramData\CrowdSec\config\bouncers\</code></pre>
<p>Dans ce fichier, vous devez modifier deux options :</p>
<ul>
  <li><strong>api_endpoint</strong></li>
  <li><strong>api_key</strong></li>
</ul>
<p>Elles sont mises en évidence sur l'image ci-dessous.</p>
<figure class="image"><img src="https://www.it-connect.fr/wp-content-itc/uploads/2024/02/CrowdSec-Windows-bouncer-firewall-Cle-API.png" srcset="https://www.it-connect.fr/wp-content-itc/uploads/2024/02/CrowdSec-Windows-bouncer-firewall-Cle-API.png 800w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/CrowdSec-Windows-bouncer-firewall-Cle-API-550x238.png 550w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/CrowdSec-Windows-bouncer-firewall-Cle-API-150x65.png 150w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/CrowdSec-Windows-bouncer-firewall-Cle-API-768x332.png 768w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/CrowdSec-Windows-bouncer-firewall-Cle-API-50x22.png 50w" sizes="100vw" width="800"></figure>
<p>Pour l'option "<strong>api_endpoint</strong>", vous devez indiquer l'adresse IP (ou le nom d'hôte) ainsi que le port de votre serveur LAPI central (soit le PfSense).</p>
<p>Pour l'option "<strong>api_key</strong>", vous devez indiquer la clé d'API obtenue précédemment via la commande "<i>cscli bouncers add</i>".</p>
<p>Ce qui donne :</p>
<figure class="image"><img src="https://www.it-connect.fr/wp-content-itc/uploads/2024/02/CrowdSec-Windows-bouncer-firewall-Cle-API-Exemple.png" srcset="https://www.it-connect.fr/wp-content-itc/uploads/2024/02/CrowdSec-Windows-bouncer-firewall-Cle-API-Exemple.png 800w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/CrowdSec-Windows-bouncer-firewall-Cle-API-Exemple-550x109.png 550w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/CrowdSec-Windows-bouncer-firewall-Cle-API-Exemple-150x30.png 150w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/CrowdSec-Windows-bouncer-firewall-Cle-API-Exemple-768x153.png 768w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/CrowdSec-Windows-bouncer-firewall-Cle-API-Exemple-50x10.png 50w" sizes="100vw" width="800"></figure>
<p>Quand c'est fait, redémarrez le service Windows correspondant au bouncer Firewall :</p>
<pre><code class="language-plaintext">Restart-Service cs-windows-firewall-bouncer</code></pre>
<p>Du côté de PfSense, si nous regardons l'onglet "<strong>Bouncers</strong>" présent sur la page de statut de CrowdSec, nous pouvons voir deux bouncers valides ! Il y a le bouncer présent en local sur PfSense et notre hôte distant sous Windows Server.</p>
<figure class="image"><img src="https://www.it-connect.fr/wp-content-itc/uploads/2024/02/CrowdSec-Multi-serveurs-avec-PfSense-800x301.png" alt="CrowdSec - Multi-serveurs avec PfSense" srcset="https://www.it-connect.fr/wp-content-itc/uploads/2024/02/CrowdSec-Multi-serveurs-avec-PfSense-800x301.png 800w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/CrowdSec-Multi-serveurs-avec-PfSense-550x207.png 550w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/CrowdSec-Multi-serveurs-avec-PfSense-150x56.png 150w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/CrowdSec-Multi-serveurs-avec-PfSense-768x289.png 768w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/CrowdSec-Multi-serveurs-avec-PfSense-50x19.png 50w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/CrowdSec-Multi-serveurs-avec-PfSense.png 1159w" sizes="100vw" width="800"></figure>
<p>La configuration est prête, vous allez pouvoir la tester...</p>
<h2>VII. Tester la configuration</h2>
<p>Pour tester cette configuration, nous allons devoir <strong>simuler un comportement malveillant</strong>. Dans le cas présent, mon serveur Web Windows Server est accessible grâce à une <strong>règle de NAT</strong> (car le reverse proxy n'est pas configuré sur le pare-feu) créée sur le pare-feu PfSense.</p>
<p>À l'aide d'une machine distante, je vais accéder à ce site Web qui est celui par défaut de IIS. Il s'agit d'un Lab et l'<strong>interface WAN de mon PfSense</strong> a l'adresse IP "<strong>192.168.1.60</strong>", donc j'effectue <strong>un scan Web sur cette adresse IP</strong> à l'aide de l'outil <strong>Nikto</strong>.</p>
<p>Ci-dessous, l'action est effectuée à partir d'une machine Kali Linux. Ce scan effectué par Nikto est bruyant et devrait alerter rapidement CrowdSec.</p>
<figure class="image"><img src="https://www.it-connect.fr/wp-content-itc/uploads/2024/02/CrowdSec-IIS-Test-Nikto.jpg" srcset="https://www.it-connect.fr/wp-content-itc/uploads/2024/02/CrowdSec-IIS-Test-Nikto.jpg 800w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/CrowdSec-IIS-Test-Nikto-550x388.jpg 550w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/CrowdSec-IIS-Test-Nikto-150x106.jpg 150w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/CrowdSec-IIS-Test-Nikto-768x541.jpg 768w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/CrowdSec-IIS-Test-Nikto-50x35.jpg 50w" sizes="100vw" width="800"></figure>
<p>En effet, nous pouvons constater qu'il y a bien eu une décision prise par CrowdSec : <strong>bloquer l'adresse IP correspondante à mon hôte Kali Linux</strong>. Le résultat ci-dessous est issu de la machine Windows Server.</p>
<figure class="image"><img src="https://www.it-connect.fr/wp-content-itc/uploads/2024/02/CrowdSec-multi-server-Adresse-IP-bannie-800x86.png" alt="CrowdSec multi-server - Adresse IP bannie" srcset="https://www.it-connect.fr/wp-content-itc/uploads/2024/02/CrowdSec-multi-server-Adresse-IP-bannie-800x86.png 800w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/CrowdSec-multi-server-Adresse-IP-bannie-550x59.png 550w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/CrowdSec-multi-server-Adresse-IP-bannie-150x16.png 150w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/CrowdSec-multi-server-Adresse-IP-bannie-768x83.png 768w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/CrowdSec-multi-server-Adresse-IP-bannie-50x5.png 50w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/CrowdSec-multi-server-Adresse-IP-bannie.png 935w" sizes="100vw" width="800"></figure>
<p>Nous pouvons voir qu'il y a eu plusieurs alertes générées :</p>
<figure class="image"><img src="https://www.it-connect.fr/wp-content-itc/uploads/2024/02/CrowdSec-Lister-les-alertes-LAPI-800x360.png" alt="CrowdSec - Lister les alertes LAPI" srcset="https://www.it-connect.fr/wp-content-itc/uploads/2024/02/CrowdSec-Lister-les-alertes-LAPI-800x360.png 800w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/CrowdSec-Lister-les-alertes-LAPI-550x248.png 550w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/CrowdSec-Lister-les-alertes-LAPI-150x68.png 150w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/CrowdSec-Lister-les-alertes-LAPI-768x346.png 768w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/CrowdSec-Lister-les-alertes-LAPI-50x23.png 50w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/CrowdSec-Lister-les-alertes-LAPI.png 864w" sizes="100vw" width="800"></figure>
<p>Mais, comment savoir si c'est le pare-feu ou le serveur web qui a pris la décision de bloquer cette adresse IP ?</p>
<p>Pour cela, nous pouvons<strong> regarder les détails de l'alerte</strong>. Par exemple, l'<strong>alerte avec l'ID numéro 4</strong> correspondant à du "<strong>http-xss-probbing</strong>". Pour cela, nous devons exécuter la commande suivante :</p>
<pre><code class="language-plaintext">cscli alerts inspect 4</code></pre>
<p>Dans les détails, nous pouvons voir la ligne "<strong>Machine :</strong>" accompagnée par un nom d'hôte. Ici, j'obtiens <strong>un ID de machine</strong> (souvenez-vous, la machine n'a pas été nommée lors de son inscription initiale). Cet identifiant correspond bien à mon serveur Web, donc c'est ce serveur qui a bloqué l'adresse IP.</p>
<p>Nous pouvons le vérifier en faisant la correspondance entre cet ID et celui visible dans la liste des machines :</p>
<pre><code class="language-plaintext">cscli machines list</code></pre>
<p>Voici le résultat en image :</p>
<figure class="image"><img src="https://www.it-connect.fr/wp-content-itc/uploads/2024/02/CrowdSec-Inspecter-une-alerte-et-identifier-hote-source-800x408.png" alt="CrowdSec - Inspecter une alerte et identifier hôte source" srcset="https://www.it-connect.fr/wp-content-itc/uploads/2024/02/CrowdSec-Inspecter-une-alerte-et-identifier-hote-source-800x408.png 800w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/CrowdSec-Inspecter-une-alerte-et-identifier-hote-source-550x280.png 550w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/CrowdSec-Inspecter-une-alerte-et-identifier-hote-source-150x76.png 150w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/CrowdSec-Inspecter-une-alerte-et-identifier-hote-source-768x391.png 768w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/CrowdSec-Inspecter-une-alerte-et-identifier-hote-source-50x25.png 50w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/CrowdSec-Inspecter-une-alerte-et-identifier-hote-source.png 1091w" sizes="100vw" width="800"></figure>
<p>Du côté de l'interface Web de PfSense, cette adresse IP est également bannie ! La décision est bien synchronisée entre tous les hôtes. Ainsi, les deux machines vont bloquer tous les flux en provenance de cette adresse IP malveillante.</p>
<figure class="image"><img src="https://www.it-connect.fr/wp-content-itc/uploads/2024/02/CrowdSec-Synchronisation-des-decisions-800x313.png" alt="CrowdSec - Synchronisation des décisions" srcset="https://www.it-connect.fr/wp-content-itc/uploads/2024/02/CrowdSec-Synchronisation-des-decisions-800x313.png 800w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/CrowdSec-Synchronisation-des-decisions-550x215.png 550w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/CrowdSec-Synchronisation-des-decisions-150x59.png 150w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/CrowdSec-Synchronisation-des-decisions-768x300.png 768w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/CrowdSec-Synchronisation-des-decisions-50x20.png 50w, https://www.it-connect.fr/wp-content-itc/uploads/2024/02/CrowdSec-Synchronisation-des-decisions.png 1146w" sizes="100vw" width="800"></figure>
<h2>VIII. Conclusion</h2>
<p>Grâce à ce tutoriel basé sur uniquement deux hôtes, nous voyons bien le potentiel et l'intérêt de CrowdSec dans une architecture multiserveur, notamment lorsqu'il y a plusieurs serveurs exposés sur Internet. Le fait de coupler les serveurs avec le pare-feu permet de bannir les adresses IP malveillantes directement en entrée du réseau, ce qui est intéressant pour protéger notre infrastructure.</p>
<p>Sachez que malgré la présence d'une authentification, tous les flux échangés entre les hôtes sont effectués en clair puisque le protocole HTTP est utilisé. Il s'agit de flux interne, entre le serveur en DMZ et le pare-feu, donc c'est acceptable. Toutefois, si vous envisagez d'utiliser un serveur LAPI externe ou qui implique que des flux vont transiter sur Internet, vous devez faire évoluer la configuration pour basculer les connexions en HTTPS.&nbsp;</p>
<p>The post <a href="https://www.it-connect.fr/installation-multiserveur-crowdsec-pfsense-windows-server-linux/">Comment mettre en place une installation multiserveur de CrowdSec ?</a> first appeared on <a href="https://www.it-connect.fr">IT-Connect</a>.</p>
<p>&nbsp;</p>
