<!--
title: MIG_UP
description: 
published: true
date: 2024-02-13T16:01:14.197Z
tags: 
editor: ckeditor
dateCreated: 2024-01-17T08:34:15.692Z
-->

<h1>PASSAGE DE 5.7.42 A 8.0.35 EN DOCKER DEPUIS UNE SAUVEGARDE STANDARD (pas docker) :</h1>
<p><a href="/COMPOSE/MYSQLCONV">Compose</a></p>
<p>Prérequis (en root)</p>
<pre><code class="language-plaintext">apt install autofs cifs-utils gzip</code></pre>
<p>&nbsp;</p>
<pre><code class="language-plaintext">mkdir /media/movebackup</code></pre>
<p>&nbsp;</p>
<pre><code class="language-plaintext">nano /root/.smbcreds</code></pre>
<p>&nbsp;</p>
<pre><code class="language-plaintext">username=movebackup
password=</code></pre>
<p>&nbsp;</p>
<pre><code class="language-plaintext">chmod 400 /root/.smbcreds</code></pre>
<p>Monter NIDFNAS01 depuis l'hôte docker de destination (en root)</p>
<pre><code class="language-plaintext">mount -t cifs -o credentials=/root/.smbcreds //nidfnas01.cyborg.dom/movebackup  /media/movebackup</code></pre>
<p>Lancer le docker mysql de conversion en 5.7.42-debian et sans sha2 et avec cap_<i>add SYS_</i>nice</p>
<p>PUIS EN admin_ac !!!</p>
<p>Lister les sauvegardes sql</p>
<pre><code class="language-plaintext">ls /media/movebackup/vdcstpm01/sql_*</code></pre>
<p>Copier la BDD dans le Docker mysql de conv</p>
<pre><code class="language-plaintext">docker cp /media/movebackup/vdcstpm01/file.gz mysqlconv:/media/file.gz</code></pre>
<p>Se connecter au docker</p>
<pre><code class="language-plaintext">docker exec -it mysqlconv bash</code></pre>
<p>Droit sur le fichier de backup</p>
<pre><code class="language-plaintext">chown root:root /media/*.gz</code></pre>
<p>Restau de la backup</p>
<pre><code class="language-plaintext">zcat /media/*.gz | mysql -uroot -p tpm_db</code></pre>
<p>Modifier la version dans le compose en 8.0.35-debian et sans sha2</p>
<p>Faire un compose UP et vérifier dans les log du docker que la conversion est réussie</p>
<p>Se connecter au docker</p>
<pre><code class="language-plaintext">docker exec -it mysqlconv bash</code></pre>
<p>Se connecter à mysql en root avec le mdp de la base d'origine</p>
<pre><code class="language-plaintext">mysql -uroot -p</code></pre>
<p>Passer tpm_user en % au lieu de localhost</p>
<pre><code class="language-plaintext">RENAME USER 'tpm_user'@'localhost' TO 'tpm_user'@'%';</code></pre>
<p>Changer les mdp de root et tpm_user</p>
<pre><code class="language-plaintext">ALTER USER 'root'@'localhost' IDENTIFIED BY 'mdp';</code></pre>
<p>&nbsp;</p>
<pre><code class="language-plaintext">ALTER USER 'tpm_user'@'%' IDENTIFIED BY 'mdp';</code></pre>
<p>Modifier et ajouter sha2 par defaut</p>
<p>Faire COMPOSE UP puis</p>
<pre><code class="language-plaintext">docker exec -it mysqlconv bash</code></pre>
<p>Modifier le plugin de connexion pour les users root et tpm_user (bien mettre le mdp)</p>
<pre><code class="language-plaintext">mysql -uroot -p</code></pre>
<p>&nbsp;</p>
<pre><code class="language-plaintext">ALTER USER 'root'@'localhost' IDENTIFIED WITH caching_sha2_password BY 'mdp';</code></pre>
<p>&nbsp;</p>
<pre><code class="language-plaintext">ALTER USER 'tpm_user'@'%' IDENTIFIED WITH caching_sha2_password BY 'mdp';</code></pre>
<p>Sortir de mysql</p>
<p>Sortir du bash mysqlconv</p>
<p>Vérifier qu'il ny ait pas déjà un fichier de backup et le supprimer si présent</p>
<p>Sauvegarder la BDD convertit ds mysqlconv depuis l'hôte docker</p>
<pre><code class="language-plaintext">docker exec -i mysqlconv mysqldump -h localhost -uroot -p tpm_db | gzip &gt; /home/admin_ac/backup/sql_bckp.sql.gz</code></pre>
<p>Arrêter le compose "conv"</p>
<p>Copier la BDD convertit dans le docker mysql du stack tpm</p>
<pre><code class="language-plaintext">docker cp /home/admin_ac/backup/sql_bckp.sql.gz mysql:/media/sql_bckp.sql.gz</code></pre>
<p>Se connecter au docker</p>
<pre><code class="language-plaintext">docker exec -it mysql bash</code></pre>
<p>Droit sur le fichier de backup</p>
<pre><code class="language-plaintext">chown root:root /media/*.gz</code></pre>
<p>Restau de la backup</p>
<pre><code class="language-plaintext">zcat /media/*.gz | mysql -uroot -p tpm_db</code></pre>
<p>compose down du stack tpm</p>
<p>compose up du stack tpm</p>
<p>Valider que le message réclamant la mise a jour de tpm est bien :</p>
<p>Les erreurs suivantes empâche le fonctionnement de Team Password Manager:<br><br>- <strong>Vous devez réaliser une mise à jour: https://mypassdev.absyscyborg.com/index.php/upgrade</strong><br><br>Veuillez contacter l'administrateur de votre système.</p>
<p><a href="/ABSYS/TPM/VDCSTPM02-DEV">PUIS</a></p>
