<!--
title: BACKUP/RESTORE
description: 
published: true
date: 2024-01-17T08:28:48.479Z
tags: 
editor: ckeditor
dateCreated: 2023-09-18T12:37:28.123Z
-->

<h1>Options</h1>
<p>--single-transaction =&gt; snapshot de la base sans ajout des modif qu'il y a pendant le dump, parfait pour zabbix au vu de la taille de la base et du temps du dumps mais inutile pour tpm, cela évite de surcharger le serveur pendant le dump, zabbix peut continuer à intégrer des valeurs pendant le dump par exemple&nbsp;</p>
<h1>Sauvegarder BDD dans un conteneur</h1>
<pre><code class="language-plaintext">docker exec -i mysql mysqldump -utpm_user -p$(cat /compose/tpm/sec/.up) tpm_db &gt; backup.sql</code></pre>
<p>&nbsp;</p>
<pre><code class="language-plaintext">docker exec -i mysql mysqldump -utpm_user -p$(cat /compose/tpm/sec/.up) tpm_db | gzip &gt; backup.sql.gz</code></pre>
<h1>Restauration BDD dans un conteneur</h1>
<pre><code class="language-plaintext">docker exec -i mysql mysql -utpm_user -p$(cat /compose/tpm/sec/.up) tpm_db &lt; /home/admin_ac/restore/backup.sql</code></pre>
<h1>SAUVEGARDE MYSQL AVEC PRIORITé TRES BASSE POUR NE PAS GENER:</h1>
<p>nice -n 19 ionice -c2 -n7 mysqldump -u root -p$(cat /root/.sqlrcreds) zabbix &gt; zabbix.sql</p>
<h1>PROCEDURE COMPLETE POUR TPM ET DEVTPM : à adapter pour zabbix et teampass</h1>
<ol>
  <li>Se connecter en root</li>
  <li>Verifier la presence de gzip, autofs, cifs-utils</li>
  <li>apt install autofs cifs-utils gzip</li>
  <li>mkdir /media/movebackup</li>
  <li>mkdir /etc/scripts</li>
  <li>chmod -R 700 /etc/scripts</li>
  <li>nano /root/.sqlcreds &gt;&gt;&gt; Taper le mot de passe root sql dans le fichier</li>
  <li>chmod 400 /root/.sqlcreds</li>
  <li>nano /root/.smbcreds</li>
</ol>
<p>username=movebackup</p>
<p>password=voir teampass</p>
<ol>
  <li>chmod 400 /root/.smbcreds</li>
  <li>mount -t cifs -o credentials=/root/.smbcreds //nidfnas01.cyborg.dom/movebackup&nbsp; /media/movebackup</li>
  <li>mkdir /media/movebackup/vdcstpm01</li>
  <li>nano /etc/scripts/movebackup.sh</li>
</ol>
<pre><code class="language-plaintext">#!/bin/sh
#Date
current_date=$(date +%F_%Hh%M)
#Nom_Serveur
host=$(hostname)
#Domaine
domain=cyborg.dom
#Retention en jours
ret=7
#Script
mount -t cifs -o credentials=/root/.smbcreds //nidfnas01.cyborg.dom/movebackup  /media/movebackup
mysqldump -uroot -p$(cat /root/.sqlrcreds) -h 127.0.0.1 tpm_db | gzip &gt; /media/movebackup/"$host"/sql_"$current_date".sql.gz
zcat /media/movebackup/"$host"/sql_"$current_date".sql.gz | tail -n1 | grep "Dump completed" | wc -l &gt;&gt; /media/movebackup/"$host"/IsOK_"$current_date".txt
test=$(cat /media/movebackup/"$host"/IsOK_"$current_date".txt)
if [ $test -eq 1 ]; then echo "Backup Successful" &gt;&gt; /media/movebackup/"$host"/_sauvegarde_du_"$current_date"_OK.txt; else echo "Backup Failure" &gt;&gt; /media/movebackup/"$host"/_sauvegarde_du_"$current_date"_KO.txt; fi
rm /media/movebackup/"$host"/IsOK_"$current_date".txt
tar -zcf /media/movebackup/"$host"/app_"$current_date".gz /var/www/html/"$host"."$domain"
tar -zcf /media/movebackup/"$host"/uploads_"$current_date".gz /media/tpmupload
find /media/movebackup/"$host"/ -ctime +"$ret" -type f -exec rm {} \;
umount /media/movebackup</code></pre>
<p>&nbsp;</p>
<ol>
  <li>chmod +x /etc/scripts/movebackup.sh</li>
  <li>crontab -e</li>
</ol>
<p>00 13,23 * * 1-5 sh /etc/scripts/movebackup.sh</p>
<ol>
  <li>systemctl restart cron</li>
  <li>Vérifier l'éxecution de la tâche</li>
</ol>
<p>&nbsp;</p>
<h1>PROCEDURE COMPLETE POUR VDCSZAB01 :&nbsp;</h1>
<ol>
  <li>Se connecter en root</li>
  <li>Verifier la presence de gzip, autofs, cifs-utils</li>
  <li>apt install autofs cifs-utils gzip</li>
  <li>mkdir /media/movebackup</li>
  <li>mkdir /etc/scripts</li>
  <li>chmod -R 700 /etc/scripts</li>
  <li>nano /root/.sqlcreds &gt;&gt;&gt; Taper le mot de passe root sql dans le fichier</li>
  <li>chmod 400 /root/.sqlcreds</li>
  <li>nano /root/.smbcreds</li>
</ol>
<p>username=movebackup</p>
<p>password=voir teampass</p>
<ol>
  <li>chmod 400 /root/.smbcreds</li>
  <li>mount -t cifs -o credentials=/root/.smbcreds //nidfnas01.cyborg.dom/movebackup&nbsp; /media/movebackup</li>
  <li>mkdir /media/movebackup/vdcszab01</li>
  <li>nano /etc/scripts/movebackup.sh</li>
</ol>
<pre><code class="language-plaintext">#!/bin/sh
current_date=$(date +%F_%Hh%M)
host=vdcszab01
#Retention en jours
ret=90 
mount -t cifs -o credentials=/root/.smbcreds //nidfnas01.cyborg.dom/movebackup&nbsp; /media/movebackup
systemctl stop zabbix-server
mysqldump -u zabbix --password=$(cat /root/.sqlcreds) -h 127.0.0.1 zabbix | gzip &gt; /media/movebackup/"$host"/bckp_sql_"$current_date".sql.gz
IsOK='zcat /media/movebackup/"$host"/bckp_sql_"$current_date".sql.gz | tail -n1 | grep "Dump completed" | wc -l'
if [ $IsOK -eq 1 ]; then echo "Backup Successful" &gt;&gt; /media/movebackup/"$host"/sauvegarde_du_"$current_date"_OK.txt; else echo "Backup Failure" &gt;&gt; /media/movebackup/"$host"/sauvegarde_du_"$current_date"_KO.txt; fi
find /media/movebackup/"$host"/ -mtime +"$ret" -type f -exec rm {} \;
umount /media/movebackup
systemctl start zabbix-server</code></pre>
<p>&nbsp;</p>
<ol>
  <li>chmod +x /etc/scripts/movebackup.sh</li>
  <li>crontab -e</li>
</ol>
<p>00 13 * * 6 sh /etc/scripts/movebackup.sh</p>
<ol>
  <li>systemctl restart cron</li>
  <li>Vérifier l'éxecution de la tâche</li>
</ol>
<p>&nbsp;</p>
<h1>SAUVEGARDE D'UNE TABLE SPE DANS UNE BDD :</h1>
<p>mysqldump -u [user] -p[password] [database] [table] &gt; [output_file_name].sql</p>
<p>mysqldump - root -p$(cat /root/.sqlrcreds) zabbix history &gt; table_history.sql</p>
<p>&nbsp;</p>
<h1>RESTAURATION D'UNE TABLE DANS UNE BDD : (tester en ajoutant la table après le nom de la BDD si erreur)</h1>
<pre><code class="language-plaintext">cat [fichier_table].sql | mysql -u [user] -p[password] [database] et tester cat [fichier_table].sql | mysql -u [user] -p[password] [database] [table] </code></pre>
<p>en cas d'erreur avec la première commande</p>
<pre><code class="language-plaintext">cat /home/zabbix/table_history.sql | mysql -u root -p$(cat /root/.sqlrcreds) zabbix</code></pre>
<p>&nbsp;</p>
<h1>SAUVEGARDE BDD ZABBIX VDCSDEVZAB02:</h1>
<p>(yum install cifs-utils) déjà fait</p>
<p>(mkdir /media/movebackup) déjà fait</p>
<p>sudo mount -t cifs -o username=movebackup,password= //nidfnas01.cyborg.dom/movebackup /media/movebackup</p>
<p>(mkdir /media/movebackup/vdcsdevzab02) déjà fait</p>
<p>systemctl stop zabbix-server</p>
<p>mysqldump -u zabbix -p3%BxxAi zabbix | gzip &gt; /media/movebackup/vdcszab02/zabbix2.sql.gz</p>
<p>systemctl start zabbix-server</p>
<p>&nbsp;</p>
<p>RESTAURER BDD SUR VDCSZAB01:</p>
<p>mkdir /media/movebackup</p>
<p>sudo mount -t cifs -o username=movebackup,password= //nidfnas01.cyborg.dom/movebackup /media/movebackup</p>
<p>zcat /media/movebackup/vdcsdevzab02/zabbix.sql.gz | mysql -uzabbix -p3%BxxAi zabbix</p>
<p>&nbsp;</p>
<h1>SAUVEGARDE TOUTES LES BDD:</h1>
<p>mysqldump -u root -pSqlRoot00! -h 127.0.0.1 --all-databases | gzip &gt; /media/movebackup/VDCSDEVTPM01/backup.sql.gz</p>
<p>&nbsp;</p>
<p>mysqldump -u root --password=$(cat /root/.sqlcreds) -h 127.0.0.1 --all-databases | gzip &gt; /media/movebackup/vidftps01/bckp_sql_test.sql.gz</p>
<p>&nbsp;</p>
<p>mysqldump -u root -p 3wj^EC/f&gt;QMF&lt;vL -h 127.0.0.1 --all-databases | gzip &gt; /media/movebackup/vidftps01/bckp_sql_test.sql.gz</p>
<p>&nbsp;</p>
<p>AJOUT MDP MYSQL DANS UN FICHIER ACCESSIBLE QUE PAR ROOT:</p>
<p>nano /root/.sqlcreds et ajouter juste le mdp:</p>
<p>SqlRoot00!</p>
<p>&nbsp;</p>
<p>chmod 400 /root/.sqlcreds (pour limiter l'accès du fichier à root)</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<h1>AJOUT CREDENTIALS DANS UN FICHIER ACCESSIBLE QUE PAR ROOT:</h1>
<p><code>nano /root/.smbcreds et ajouter :</code></p>
<p><code>username=movebackup</code></p>
<p><code>password=motdepasse</code></p>
<p><code>chmod 400 /root/.smbcreds (pour limiter l'accès du fichier à root)</code></p>
<h1>SCRIPT SAUVEGARDE MYSQL SUR UN LECTEUR RESEAUX: (mettre les login mysql dans un fichier accessible que par root et créer les rep de montage /media/movebackup)</h1>
<pre><code class="language-plaintext">#!/bin/sh
current_date=$(date +%F_%Hh%M)
mount -t cifs -o credentials=/root/.smbcreds //nidfnas01.cyborg.dom/movebackup&nbsp; /media/movebackup
mysqldump -u root --password=$(cat /root/.sqlcreds) -h 127.0.0.1 --all-databases | gzip &gt; /media/movebackup/vdcsdevtpm01/bckp_sql_"$current_date".sql.gz
IsOK=`zcat /media/movebackup/vdcsdevtpm01/bckp_sql_"$current_date".sql.gz | tail -n1 | grep "Dump completed" | wc -l`
if [ $IsOK -eq 1 ]; then echo "Backup Successful" &gt;&gt; /media/movebackup/vdcsdevtpm01/sauvegarde_du_"$current_date"_OK.txt; else echo "Backup Failure" &gt;&gt; /media/movebackup/vdcsdevtpm01/sauvegarde_du_"$current_date"_KO.txt; fi
find /media/movebackup/vdcsdevtpm01/ -mtime +7 -type f -exec rm {} \;
umount /media/movebackup</code></pre>
<p>&nbsp;</p>
<p>&nbsp;</p>
<figure class="table">
  <table style="border-bottom:1pt solid #A3A3A3;border-left:1pt solid #A3A3A3;border-right:1pt solid #A3A3A3;border-top:1pt solid #A3A3A3;">
    <tbody>
      <tr>
        <td style="border-bottom:1pt solid #A3A3A3;border-left:1pt solid #A3A3A3;border-right:1pt solid #A3A3A3;border-top:1pt solid #A3A3A3;padding:4pt;vertical-align:top;width:2.5881in;">chmod -R 700 /etc/scripts&nbsp;</td>
        <td style="border-bottom:1pt solid #A3A3A3;border-left:1pt solid #A3A3A3;border-right:1pt solid #A3A3A3;border-top:1pt solid #A3A3A3;padding:4pt;vertical-align:top;width:5.4826in;">pour rendre accessible au propriétaire du dossier (chown) à savoir root dans notre cas</td>
      </tr>
      <tr>
        <td style="border-bottom:1pt solid #A3A3A3;border-left:1pt solid #A3A3A3;border-right:1pt solid #A3A3A3;border-top:1pt solid #A3A3A3;padding:4pt;vertical-align:top;width:2.6076in;">chmod +x /etc/scripts/movebackup.sh</td>
        <td style="border-bottom:1pt solid #A3A3A3;border-left:1pt solid #A3A3A3;border-right:1pt solid #A3A3A3;border-top:1pt solid #A3A3A3;padding:4pt;vertical-align:top;width:5.3937in;">&nbsp;pour rendre le scripts executable</td>
      </tr>
    </tbody>
  </table>
</figure>
<p>&nbsp;</p>
<h1>PROGRAMMATION DU SCRIPT DE SAUVEGARDE SQL AVEC CRON:</h1>
<p>&nbsp;</p>
<p>crontab -e pour acceder à la planification de CRON puis ajouter la prog</p>
<p>&nbsp;</p>
<p>00 13,23 * * 1-5 user commande (à 13 et 23 heures tous les jours de la semaine)</p>
<p>00 13,23 * * 1-5 sh /etc/scripts/movebackup.sh (à 13 et 23 heures tous les jours de la semaine)</p>
<p>00 13,23 * * 1-5 sh /etc/scripts/movebackupdaily.sh (à 13 et 23 heures tous les jours de la semaine)</p>
<p>00 13 * * 6 sh /etc/scripts/movebackupweekly.sh (à 13 heures tous les samedis du mois)</p>
<p>00 22 10 * * sh /etc/scripts/movebackupmonthly.sh (à 22 heures tous les 10 des mois de l'année)</p>
