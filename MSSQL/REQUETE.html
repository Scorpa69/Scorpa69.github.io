<!--
title: REQUETE
description: 
published: true
date: 2023-12-12T09:52:26.891Z
tags: 
editor: ckeditor
dateCreated: 2023-09-18T12:37:24.174Z
-->

<h2>Sauvegarde BDD</h2>
<pre><code class="language-plaintext">backup database [susdb] to disk = 'D:\Backup\susdb.bak' with copy_only</code></pre>
<h2>SUPPRESSION USER ET SES DROITS SUR LES BDD</h2>
<pre><code class="language-plaintext">DECLARE @DBname NVARCHAR(128);
DECLARE @SQL NVARCHAR(MAX);

DECLARE DB_Cursor CURSOR FOR
SELECT name FROM sys.databases
WHERE name NOT IN ('master', 'tempdb', 'model', 'msdb');

OPEN DB_Cursor;

FETCH NEXT FROM DB_Cursor INTO @DBname;

WHILE @@FETCH_STATUS = 0
BEGIN
   SET @SQL = 'USE [' + @DBname + ']; DROP USER [nom_de_l_utilisateur];';

   EXEC sp_executesql @SQL;

   FETCH NEXT FROM DB_Cursor INTO @DBname;
END

CLOSE DB_Cursor;
DEALLOCATE DB_Cursor;</code></pre>
<p>OU&nbsp;</p>
<p>(!!Attention supprime les objet dont le user est propriétaire dans les bases!!)</p>
<pre><code class="language-plaintext">DROP USER &lt;user_name&gt; CASCADE;</code></pre>
<h2>DROITS USER SUR CHAQUE BASE D'UN SERVEUR</h2>
<pre><code class="language-plaintext">USE master;
GO

DECLARE @DBname NVARCHAR(128);
DECLARE @SQL NVARCHAR(MAX);

DECLARE DB_Cursor CURSOR FOR
SELECT name FROM sys.databases
WHERE name NOT IN ('master', 'tempdb', 'model', 'msdb');

OPEN DB_Cursor;

FETCH NEXT FROM DB_Cursor INTO @DBname;

WHILE @@FETCH_STATUS = 0
BEGIN
   SET @SQL = 'USE [' + @DBname + ']; SELECT d.name, p.[name] AS principal_name, dp.permission_name, dp.state_desc  
               FROM sys.database_permissions dp
               JOIN sys.database_principals p ON dp.grantee_principal_id = p.principal_id
               JOIN sys.database_principals d ON dp.major_id = d.principal_id
               WHERE p.[type] IN (''U'', ''S'', ''G'')
               ORDER BY d.name, p.[name]';

   PRINT '---------------------------------------------';
   PRINT 'Database: ' + @DBname;
   PRINT '---------------------------------------------';

   EXEC sp_executesql @SQL;

   FETCH NEXT FROM DB_Cursor INTO @DBname;
END

CLOSE DB_Cursor;
DEALLOCATE DB_Cursor;</code></pre>
<h2>INFO SERVEUR SQL</h2>
<pre><code class="language-plaintext">SELECT 
  SERVERPROPERTY('MachineName') AS ComputerName,
  SERVERPROPERTY('ServerName') AS InstanceName, 
  SERVERPROPERTY('Edition') AS Edition,
  SERVERPROPERTY('ProductVersion') AS ProductVersion, 
  SERVERPROPERTY('ProductLevel') AS ProductLevel; 
GO</code></pre>
<p>&nbsp;</p>
<h2>PORT SQL UTILISÉ</h2>
<pre><code class="language-plaintext">SELECT DISTINCT local_tcp_port FROM sys.dm_exec_connections WHERE local_tcp_port IS NOT NULL</code></pre>
<p>OU</p>
<pre><code class="language-plaintext">EXEC xp_ReadErrorLog 0, 1, N'Server is listening on', N'any', NULL, NULL, 'DESC'
GO</code></pre>
<p>OU</p>
<pre><code class="language-plaintext">SELECT local_tcp_port
FROM sys.dm_exec_connections
WHERE session_id = @@SPID;
GO</code></pre>
<h2>C_USER AUTORISATIONS</h2>
<p>Sélectionner la base concerné puis nouveau script :</p>
<pre><code class="language-plaintext">sp_change_users_login 'update_one', 'user_cbase', 'APPL_CBASE'
ALTER USER [USER_CBASE] WITH LOGIN = [APPL_CBASE]
USE master;
alter authorization on DATABASE :: [NOMBASE] to SA;</code></pre>
<p>&nbsp;</p>
<h2>SUPPR OSS LEC</h2>
<pre><code class="language-plaintext">declare curX cursor local for
      select sys.objects.type, sys.objects.name from sys.objects inner join sys.schemas on sys.objects.schema_id = sys.schemas.schema_id where sys.schemas.name = 'oss'
      union all  
      select sys.objects.type, sys.objects.name from sys.objects where type = 'TA' and name like 'oss%'
declare @type as nvarchar(10)
declare @name as sysname
open curX
fetch next from curX into @type, @name
while @@fetch_status = 0
begin
      if @type = 'TA'
            execute ('drop trigger ' +  @name)
      else if @type = 'FS'
            execute ('drop function oss.' +  @name)
      else if @type = 'FT'
            execute ('drop function oss.' +  @name)
      else if @type = 'PC'
            execute ('drop procedure oss.' +  @name)
      fetch next from curX into @type, @name
end
close curX
deallocate curX
IF  EXISTS (SELECT * FROM sys.triggers WHERE parent_class_desc = 'DATABASE' AND name = N'OSS_TrackAlterTable')
  DROP TRIGGER [OSS_TrackAlterTable] ON DATABASE;
IF  EXISTS (SELECT * FROM sys.assemblies WHERE name = 'CompagnonOSS')
      DROP ASSEMBLY "CompagnonOSS";
IF  EXISTS (SELECT * FROM sys.assemblies WHERE name = 'CompagnonOSSExtension')
      DROP ASSEMBLY "CompagnonOSSExtension";
IF  EXISTS (SELECT * FROM sys.assemblies WHERE name = 'CompagnonOSSSchemaSage100.XmlSerializers')
  DROP ASSEMBLY "CompagnonOSSSchemaSage100.XmlSerializers";
IF  EXISTS (SELECT * FROM sys.assemblies WHERE name = 'CompagnonOSSSchemaSage100')
  DROP ASSEMBLY "CompagnonOSSSchemaSage100";
IF  EXISTS (SELECT * FROM sys.assemblies WHERE name = 'ARCADIE.Utilities.LicensingClient.XmlSerializers')
  DROP ASSEMBLY "ARCADIE.Utilities.LicensingClient.XmlSerializers";
IF  EXISTS (SELECT * FROM sys.assemblies WHERE name = 'ARCADIE.Utilities.LicensingClient')
  DROP ASSEMBLY "ARCADIE.Utilities.LicensingClient";
--DROP TABLE oss.columns
--DROP TABLE oss.configuration
--DROP TABLE oss.events
--DROP TABLE oss.events_data
--DROP TABLE oss.sessions
--DROP TABLE oss.tables
--ALTER DATABASE NOMBDD  REMOVE FILE NOMBDD_OSS</code></pre>
