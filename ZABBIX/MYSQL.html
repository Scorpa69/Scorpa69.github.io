<!--
title: MYSQL
description: 
published: true
date: 2024-02-14T13:13:33.652Z
tags: 
editor: ckeditor
dateCreated: 2024-01-12T06:50:03.719Z
-->

<p>Le nom est TEMPLATE DB MYSQL by ZABBIX AGENT</p>
<p>&nbsp;</p>
<p>COMMANDES:</p>
<p>mysql -u root -p</p>
<p>CREATE USER 'zabbix_monitor'@'%' IDENTIFIED BY 'pwd';</p>
<p>GRANT USAGE ON *.* TO 'zabbix_monitor'@'%';</p>
<p>GRANT USAGE,REPLICATION CLIENT,PROCESS,SHOW DATABASES,SHOW VIEW ON *.* TO 'zabbix_monitor'@'%';</p>
<p>FLUSH PRIVILEGES;</p>
<p>Quit;</p>
<p>sudo nano /etc/mysql/my.cnf et ajouter :&nbsp;</p>
<p>[client]</p>
<p>user='zabbix_monitor'</p>
<p>password='voir teampass'</p>
<p>host='vdcsdevtpm01.cyborg.dom' (ou localhost)</p>
<p>sudo nano /etc/zabbix/zabbix_agentd.d/userparameter_mysql.conf et ajouter : (FAIRE ATTENTION AU CHEMIN DE L'INCLUDE!!!!)</p>
<p>UserParameter=mysql.ping[*], mysqladmin -h"$1" -P"$2" ping</p>
<p>UserParameter=mysql.get_status_variables[*], mysql -h"$1" -P"$2" -sNX -e "show global status"</p>
<p>UserParameter=mysql.version[*], mysqladmin -s -h"$1" -P"$2" version</p>
<p>UserParameter=mysql.db.discovery[*], mysql -h"$1" -P"$2" -sN -e "show databases"</p>
<p>UserParameter=mysql.dbsize[*], mysql -h"$1" -P"$2" -sN -e "SELECT COALESCE(SUM(DATA_LENGTH + INDEX_LENGTH),0) FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA='$3'"</p>
<p>UserParameter=mysql.replication.discovery[*], mysql -h"$1" -P"$2" -sNX -e "show slave status"</p>
<p>UserParameter=mysql.slave_status[*], mysql -h"$1" -P"$2" -sNX -e "show slave status"</p>
<p>systemctl restart mysql zabbix-agent</p>
<p>systemctl status mysql zabbix-agent</p>
<p>Pour tester les droits : mysqladmin -h"localhost" -P"3306" ping</p>
<p>Si l'agent ne veut pas démarrer regarder le log : tail -n 20 /var/log/zabbix/zabbix_agentd.log</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<ol>
  <li>Créer un user mysql avec les droits aux bases suivants : USAGE,REPLICATION CLIENT,PROCESS,SHOW DATABASES,SHOW VIEW (voir onglet MySQL), ne pas oublier le flushprivileges !!!!</li>
  <li>Créer le fichier /var/lib/zabbix/.my.cnf avec les ID/MDP du user mysql comme indiqué ci-dessous (cf fichier .my.cnf)</li>
  <li>Vérifier que ce fichier est bien inclut dans la conf php : à terminer</li>
  <li>Installer l'agent sur le serveur à monitorer (Voir INSTALL AGENT LINUX)</li>
  <li>Modifier le fichier zabbix_agentd.conf qui se trouve dans /etc/zabbix/ : Ajouter le include vers le fichier userparameter_mysql.conf : Include=/usr/local/etc/zabbix_agentd.d/userparameter_mysql.conf</li>
  <li>Créer le dossier zabbix_agentd.d de façon permanente : cd /usr/local/etc puis mkdir -p zabbix_agentd.d</li>
  <li>Créer le fichier userparameter_mysql.conf dans le dossier /usr/local/etc/zabbix_agentd.d avec les infos ci-dessous (cf fichier userparameter_mysql.conf)</li>
  <li>Redémarrer les sevices mysql et zabbix-agent (systemctl restart mysql zabbix-agent)</li>
  <li>Vérifier le bon fonctionnement en se connectant au user Zabbix puis en essayant les commande du fichier userparameter_mysql.conf en enlevant userparameter=nomdelaclé et les valeur $1 ou $2 ou $3</li>
</ol>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>Fichier .my.cnf : (fichier ou il faut ajouter les identifiants du user mysql créé)</p>
<p>nano /var/lib/zabbix/.my.cnf</p>
<p>Et ajouter :</p>
<p>[mysql]</p>
<p>user=zabbix_monitor</p>
<p>password='mdp'</p>
<p>host=vdcsdevtpm01.cyborg.dom</p>
<p>&nbsp;</p>
<p>[client]</p>
<p>user=zabbix_monitor</p>
<p>password='mdp'</p>
<p>host=vdcsdevtpm01.cyborg.dom</p>
<p>&nbsp;</p>
<p>Ficher userparameter_mysql.conf dans /usr/local/etc/zabbix_agentd.conf/ :</p>
<p>nano /usr/local/etc/zabbix_agentd.conf.d/userparameter_mysql.conf</p>
<p>Et ajouter :</p>
<p>UserParameter=mysql.status[*],echo "show global status where Variable_name='$1';" | HOME=/var/lib/zabbix mysql -N | awk '{print $$2}'</p>
<p>UserParameter=mysql.size[*],bash -c 'echo "select sum($(case "$3" in both|"") echo "data_length+index_length";; data|index) echo "$3_length";; free) echo "data_free";; esac)) from information_schema.tables$([[ "$1" = "all" || ! "$1" ]]$</p>
<p>UserParameter=mysql.uptime,HOME=/var/lib/zabbix mysqladmin status | cut -f2 -d ":" | cut -f1 -d "T" | tr -d " "</p>
<p>UserParameter=mysql.threads,HOME=/var/lib/zabbix mysqladmin status | cut -f3 -d ":" | cut -f1 -d "Q" | tr -d " "</p>
<p>UserParameter=mysql.questions,HOME=/var/lib/zabbix mysqladmin status | cut -f4 -d ":"|cut -f1 -d "S" | tr -d " "</p>
<p>UserParameter=mysql.slowqueries,HOME=/var/lib/zabbix mysqladmin status | cut -f5 -d ":" | cut -f1 -d "O" | tr -d " "</p>
<p>UserParameter=mysql.qps,HOME=/var/lib/zabbix mysqladmin status | cut -f9 -d ":" | tr -d " "</p>
<p>UserParameter=mysql.ping[*], mysqladmin -h"$1" -P"$2" ping</p>
<p>UserParameter=mysql.version[*], mysqladmin -s -h"$1" -P"$2" version</p>
<p>UserParameter=mysql.db.discovery[*],HOME=/var/lib/zabbix mysql -h"$1" -P"$2" -sN -e "show databases"</p>
<p>UserParameter=mysql.dbsize[*],HOME=/var/lib/zabbix mysql -h"$1" -P"$2" -sN -e "SELECT COALESCE(SUM(DATA_LENGTH + INDEX_LENGTH),0) FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA='$3'"</p>
<p>UserParameter=mysql.replication.discovery[*],HOME=/var/lib/zabbix mysql -h"$1" -P"$2" -sNX -e "show slave status"</p>
<p>UserParameter=mysql.slave_status[*],HOME=/var/lib/zabbix mysql -h"$1" -P"$2" -sNX -e "show slave status"</p>
<p>UserParameter=mysql.get_status_variables[*],HOME=/var/lib/zabbix mysql -h"$1" -P"$2" -sNX -e "show global status"</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>Pour tester depuis l'agent :&nbsp;</p>
<ul>
  <li>se connecter en tant que zabbix (depuis la session root faire un su - zabbix -s /bin/bash)</li>
  <li>tester la commande echo "show global status where Variable_name='$1';" | HOME=/var/lib/zabbix mysql -N</li>
  <li>Tester les autres commande du fichier userparameter, si cela fonctionne sur l'agent, cela fonctionnera sur le server zabbix</li>
</ul>
