<!--
title: FILESERVER
description: 
published: true
date: 2023-09-18T12:40:30.363Z
tags: 
editor: ckeditor
dateCreated: 2023-09-18T12:40:29.291Z
-->

<h1>CREATION DU DISQUE 2</h1>
<p>mkdir /media/storage</p>
<p>fdisk /dev/sdb</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp;m pour l'aide</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp;g pour créer une parttion GPT vide</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp;p pour voir l'existant</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp;n pour faire une nouvelle partition</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp;w ecrire la table et quitter fdisk</p>
<p>mkfs.ext4 /dev/sdb1</p>
<p>tune2fs /dev/sdb1 -m 0 -L DATA</p>
<p>blkid pour avoir UUID</p>
<p>nano /etc/fstab (pour ajouter la partition et le point de montage créé au dessus)</p>
<p>Ajouter la ligne correspondant à la partition dans le fichier fstab comme dans l'exemple ci-dessous</p>
<p>UUID= /media/storage ext4 defaults 0 2</p>
<p>mount -all (pour relire fstab et monter la partition créée)</p>
<p>mount (pour voir les partition montées)</p>
<p>chown -R mboa:mboa /media/storage</p>
<p>chmod 0755 /media/storage</p>
<h1>INSTALL SAMBA</h1>
<p>apt install samba</p>
<p>systemctl enable smbd</p>
<p>smbpasswd -a mboa</p>
<p>nano /etc/samba/smb.conf et modifier les lignes en bas pour écrire dans le dossier user</p>
<p>systemctl restart smbd</p>
<h1>CONFIG SAMBA SERVEUR FICHIER</h1>
<pre><code class="language-plaintext">[global]
workgroup = WORKGROUP
server string = Samba Server %v
netbios name = vmbosmb
security = user
map to guest = Bad User
dns proxy = no
guest account = nobody

[storage]
comment = Shared Folder
path = /media/storage
valid users = mboa
read only = no
create mask = 0775
directory mask = 0775
force user = mboa
force group = mboa</code></pre>
<h1>CONFIG FAIL2BAN</h1>
<p>apt install fail2ban</p>
<p>cp /etc/fail2ban/jail.conf /etc/fail2ban/jail.local</p>
<p>nano /etc/fail2ban/jail.local</p>
<p>systemctl enable fail2ban</p>
<p>systemctl restart fail2ban</p>
<pre><code class="language-plaintext">[DEFAULT]
ignoreip = 127.0.0.1/8
bantime = 1h
findtime = 10m
maxretry = 3

[ssh]
enabled = true
port = ssh
filter = sshd
logpath = /var/log/auth.log

[smb]
enabled = true
port = smb
filter = samba
logpath = /var/log/samba/log.%m
maxretry = 5</code></pre>
<h1>AUTRE EXEMPLE : (User R/W et Anonymous Readonly)</h1>
<p><code>nano /etc/samba/smb.conf</code></p>
<pre><code class="language-plaintext">[global]
   workgroup = WORKGROUP
   server string = Samba Server %v
   netbios name = your_server_name
   security = user
   map to guest = Bad User
   log file = /var/log/samba/log.%m
   max log size = 1000
   log level = 1
   syslog = 0
   panic action = /usr/share/samba/panic-action %d
   encrypt passwords = true
   passdb backend = tdbsam
   obey pam restrictions = yes
   unix password sync = yes
   passwd program = /usr/bin/passwd %u
   passwd chat = *Enter\snew\s*\spassword:* %n\n *Retype\snew\s*\spassword:* %n\n *password\supdated\ssuccessfully* .
   pam password change = yes
   load printers = no
   printing = bsd
   printcap name = /dev/null
   disable spoolss = yes
   socket options = TCP_NODELAY
   client min protocol = SMB2
   server min protocol = SMB2

[secure_share]
   path = /srv/samba/secure_share
   valid users = your_username
   write list = your_username
   guest ok = yes
   writable = no
   browsable = yes
   create mask = 0755
   directory mask = 0755
</code></pre>
<p><strong>Instructions to set up the Samba server:</strong></p>
<p>Install Samba:</p>
<pre><code class="language-plaintext">sudo apt-get update
sudo apt-get install samba
</code></pre>
<p>Create a user and set a Samba password:</p>
<pre><code class="language-plaintext">sudo useradd -M -s /sbin/nologin your_username
sudo smbpasswd -a your_username
</code></pre>
<p>Create the secure share directory and set the appropriate permissions:</p>
<pre><code class="language-plaintext">sudo mkdir -p /srv/samba/secure_share
sudo chown your_username:your_username /srv/samba/secure_share
sudo chmod 0755 /srv/samba/secure_share
</code></pre>
<p>Replace the contents of <code>/etc/samba/smb.conf</code> with the example configuration provided above. Be sure to replace <code>your_server_name</code> and <code>your_username</code> with the appropriate values.</p>
<p>Restart the Samba service:</p>
<pre><code class="language-plaintext">sudo systemctl restart smbd
</code></pre>
<p>Configure the firewall to allow Samba traffic:</p>
<pre><code class="language-plaintext">sudo ufw allow Samba</code></pre>
