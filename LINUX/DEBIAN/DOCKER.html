<!--
title: DOCKER
description: 
published: true
date: 2024-02-12T10:14:28.638Z
tags: 
editor: ckeditor
dateCreated: 2023-09-18T12:40:27.688Z
-->

<h1>INSTALL</h1>
<p>Attacher un deuxième disque/partition pour le dossier docker :</p>
<pre><code class="language-plaintext">mkdir /data</code></pre>
<p>&nbsp;</p>
<pre><code class="language-plaintext">fdisk /dev/sdb</code></pre>
<p>&nbsp; &nbsp; &nbsp; &nbsp;m pour l'aide</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp;g pour créer une parttion GPT vide</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp;p pour voir l'existant</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp;n pour faire une nouvelle partition</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp;w ecrire la table et quitter fdisk</p>
<pre><code class="language-plaintext">mkfs.ext4 /dev/sdb1</code></pre>
<p>pour récupérer de l'espace sur la partition DATA</p>
<pre><code class="language-plaintext">tune2fs /dev/sdb1 -m 0 -L DATA</code></pre>
<p>pour avoir l'UUID</p>
<pre><code class="language-plaintext">blkid </code></pre>
<pre><code class="language-plaintext">nano /etc/fstab</code></pre>
<p>Ajouter la ligne correspondant à la partition dans le fichier fstab comme dans l'exemple ci-dessous</p>
<pre><code class="language-plaintext">UUID=     /data     ext4    defaults,     0     2</code></pre>
<pre><code class="language-plaintext">mount -all</code></pre>
<pre><code class="language-plaintext">mount</code></pre>
<pre><code class="language-plaintext">for pkg in docker.io docker-doc docker-compose podman-docker containerd runc; do apt-get remove $pkg; done</code></pre>
<pre><code class="language-plaintext">apt install apt-transport-https ca-certificates curl gnupg lsb-release -y</code></pre>
<pre><code class="language-plaintext">install -m 0755 -d /etc/apt/keyrings</code></pre>
<pre><code class="language-plaintext">curl -fsSL https://download.docker.com/linux/debian/gpg -o /etc/apt/keyrings/docker.asc</code></pre>
<pre><code class="language-plaintext">chmod a+r /etc/apt/keyrings/docker.asc</code></pre>
<pre><code class="language-plaintext">echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/debian $(. /etc/os-release &amp;&amp; echo "$VERSION_CODENAME") stable" | tee /etc/apt/sources.list.d/docker.list &gt; /dev/null</code></pre>
<pre><code class="language-plaintext">apt update</code></pre>
<pre><code class="language-plaintext">apt install -y docker-ce docker-ce-cli containerd.io docker-compose docker-buildx-plugin docker-compose-plugin</code></pre>
<pre><code class="language-plaintext">usermod -aG docker admin_ac</code></pre>
<pre><code class="language-plaintext">systemctl enable docker</code></pre>
<pre><code class="language-plaintext">reboot</code></pre>
<h1>SECURISATION PROD</h1>
<h2>CONFIG DAEMON</h2>
<pre><code class="language-plaintext">nano /etc/docker/daemon.json</code></pre>
<p>&nbsp;</p>
<pre><code class="language-plaintext">{
  "userns-remap": "default",
  "icc": false,
  "log-driver": "syslog",
  "live-restore": true,
  "userland-proxy": false,
  "no-new-privileges": true
 }</code></pre>
<p>data-root n'est nécessaire que si le dossier docker n'est plus à son emplacement d'origine et pour le userns-remap il faut suivre la partie ci-dessous</p>
<h2>USER NAME SPACE</h2>
<pre><code class="language-plaintext">groupadd -g 500000 dockremap &amp;&amp; groupadd -g 501000 dockremap-user &amp;&amp; useradd -u 500000 -g dockremap -s /bin/false dockremap &amp;&amp; useradd -u 501000 -g dockremap-user -s /bin/false dockremap-user</code></pre>
<p>&nbsp;</p>
<pre><code class="language-plaintext">echo "dockremap:500000:65536" &gt;&gt; /etc/subuid &amp;&amp; echo "dockremap:500000:65536" &gt;&gt;/etc/subgid</code></pre>
<p>&nbsp;</p>
<pre><code class="language-plaintext">systemctl daemon-reload &amp;&amp; systemctl restart docker</code></pre>
<h2>AUDIT : ajout de la surveillance</h2>
<pre><code class="language-plaintext">apt-get install auditd</code></pre>
<p>&nbsp;</p>
<pre><code class="language-plaintext">nano /etc/audit/audit.rules</code></pre>
<p>copier ce qui suit dans le fichier :</p>
<pre><code class="language-plaintext">-w /usr/bin/docker -p wa
-w /var/lib/docker -p wa
-w /etc/docker -p wa
-w /lib/systemd/system/docker.service -p wa
-w /lib/systemd/system/docker.socket -p wa
-w /etc/default/docker -p wa
-w /etc/docker/daemon.json -p wa
-w /usr/bin/docker-containerd -p wa
-w /usr/bin/docker-runc -p wa</code></pre>
<p>&nbsp;</p>
<pre><code class="language-plaintext">nano /etc/audit/auditd.conf</code></pre>
<p>puis ajuster:</p>
<pre><code class="language-plaintext">La taille max du fichier en MB:
max_log_file = 1000
Le nombre de fichier de log conservé:
num_logs = 3</code></pre>
<p>&nbsp;</p>
<pre><code class="language-plaintext">systemctl restart auditd &amp;&amp; systemctl enable auditd</code></pre>
<p>Enfin un tour du côté de logrotate qui par défaut dans Debian</p>
<pre><code class="language-plaintext">nano /etc/logrotate.d/rsyslog</code></pre>
<p>le paramètre rotate permet d'ajuster la rétention puisque que c'est le nombre de journal archivé conservé</p>
<h1>PARTTION DEDIÉ DOCKER : Déplacement après install Docker</h1>
<p>1. Stop the docker daemon :</p>
<pre><code class="language-plaintext">systemctl stop docker</code></pre>
<p>2. Add a configuration file to tell the docker daemon what is the location of the data directory</p>
<p>Using your preferred text editor add a file named daemon.json under the directory /etc/docker. The file should have this content:</p>
<pre><code class="language-plaintext">nano /etc/docker/daemon.json</code></pre>
<p>&nbsp;</p>
<pre><code class="language-plaintext">{
 "data-root": "/path/to/your/docker"
}</code></pre>
<p>of course you should customize the location “/path/to/your/docker” with the path you want to use for your new docker data directory.</p>
<p>&nbsp;</p>
<p>3. Copy the current data directory to the new one</p>
<pre><code class="language-plaintext">cp -apR /var/lib/docker/. /var/lib/docker2</code></pre>
<p>4. Rename the old docker directory</p>
<pre><code class="language-plaintext">mv /var/lib/docker /var/lib/docker.old</code></pre>
<p>This is just a sanity check to see that everything is ok and docker daemon will effectively use the new location for its data.</p>
<p>5. Restart the docker daemon</p>
<pre><code class="language-plaintext">systemctl start docker</code></pre>
<p>6. Test</p>
<p>If everything is ok you should see no differences in using your docker containers. When you are sure that the new directory is being used correctly by docker daemon you can delete the old data directory.</p>
<pre><code class="language-plaintext">sudo rm -rf /var/lib/docker.old</code></pre>
