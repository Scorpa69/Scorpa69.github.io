<!--
title: PLAN-APP
description: 
published: true
date: 2023-09-25T13:23:19.594Z
tags: 
editor: ckeditor
dateCreated: 2023-09-18T12:35:38.798Z
-->

<h1>Schedule Scale Up/Down an Azure App Service Plan with Automation Account</h1>
<p>Create an azure automation account</p>
<p>Create a runbook upscale :</p>
<pre><code class="language-plaintext">workflow upscale_plan_shared_prod_005 {
   try {
   "Logging in to Azure..."
   Connect-AzAccount -Identity
   }
   catch {
   Write-Error -Message $_.Exception
   throw $_.Exception
   }
   # Converter: Wrapping initial script in an InlineScript activity, and passing any parameters for use within the InlineScript
   # Converter: If you want this InlineScript to execute on another host rather than the Automation worker, simply add some combination of -PSComputerName, -PSCredential, -PSConnectionURI, or other workflow common parameters (http://technet.microsoft.com/en-us/library/jj129719.aspx) as parameters of the InlineScript
   # Start the App Service
   Set-AzAppServicePlan -Name "plan-shared-prod-005" -ResourceGroupName "rg-shared-prod-003" -Tier "PremiumV3" -WorkerSize "Large"
}</code></pre>
<p>Create a schedule</p>
<p>Associate the schedule with the runbook</p>
<p>FIN</p>
<h1>Automatically Scale Up an Azure App Service Plan</h1>
<p><strong>Azure App Service</strong> is a hugely popular cloud service used to host, scale and manage web applications. An <strong>Azure App Service Plan</strong> is the component which defines the infrastructure used to host those web applications. It specifies the number of instances used to host the web applications as well as the size of the those instances. There’s two ways to scale an Azure App Service Plan: <strong>scaling out</strong> and <strong>scaling up</strong>.</p>
<p>Scaling out is also known as <strong>horizontal scaling</strong>. It involves adding more instances to the Azure App Service Plan. We can manually change the number of instances by using the Azure Portal or running an ad-hoc script with the Azure CLI or Azure PowerShell. However, we can also set rules based on metrics to automatically scale out the number of instances using an out-of-the-box feature of Azure App service.</p>
<p>Scaling up is also known as <strong>vertical scaling</strong>. It involves upgrading the instances to a larger size which can provide more compute and memory. We can scale up manually just like we can scale out manually. However, there is no native Azure App Service feature at this time which allows us to automatically scale up based on metrics. When workloads must be autoscaled, but they don’t or can’t benefit from horizontal scaling, we need to build our own solution.</p>
<p>We’re going to demonstrate such a solution which automatically scales up an Azure App Service Plan from a <strong>Standard S1</strong> size to a <strong>Standard S2</strong> size when the CPU usage goes above 75%.</p>
<h2>Prerequisites</h2>
<p>We’ll need the following to implement the solution presented:</p>
<ul>
  <li>An Azure subscription</li>
  <li>An existing Azure App Service Plan on our subscription</li>
  <li>Azure CLI installed</li>
  <li>Azure PowerShell installed</li>
  <li>Azure Functions Core Tools version 3.X installed</li>
</ul>
<h2>Solution Overview</h2>
<p>Before we start with our implementation, we’ve presented the solution overview to give us some context.</p>
<figure class="image image_resized" style="width:680px;"><img src="https://i0.wp.com/permanentiteration.com/wp-content/uploads/2021/06/scaleUpAppServicePlan-1.png?resize=431%2C262&amp;ssl=1" alt="" srcset="https://i0.wp.com/permanentiteration.com/wp-content/uploads/2021/06/scaleUpAppServicePlan-1.png?w=431&amp;ssl=1 431w, https://i0.wp.com/permanentiteration.com/wp-content/uploads/2021/06/scaleUpAppServicePlan-1.png?resize=300%2C182&amp;ssl=1 300w" sizes="100vw" width="431"></figure>
<ol>
  <li><strong>Azure Monitor</strong> fires an <strong>alert </strong>when the CPU usage of the Azure App Service Plan goes above 75%.</li>
  <li>The <strong>action group</strong> associated with the alert calls an <strong>Azure Function</strong>.</li>
  <li>The Azure Function runs an Azure PowerShell command to scale up the app service plan.</li>
</ol>
<h2>Create and Deploy the Azure Function</h2>
<p>Looking at our solution overview above, we can see that the Azure Function is the component which actually scales up the Azure App Service Plan. Let’s build that function first. To follow this tutorial, we’ll need the Azure Functions Core Tools version 3.X and Azure PowerShell installed. The completed source code for the Azure Function App can also be found here.</p>
<p>Open a PowerShell prompt and run the following commands to generate the initial source code for the PowerShell function:</p>
<pre><code class="language-plaintext">mkdir ScaleFunction
cd ScaleFunction
#Generate the code for a PowerShell function app
func init ScaleFunction --powershell
cd ScaleFunction
#Generate the code for an Http-Triggered function called ScaleUp
func new --template "Http Trigger" --name ScaleUp --language PowerShell
</code></pre>
<p>As part of our generated code, we should see a file called <strong>requirements.psd1</strong>. Open it and replace the contents with the following. This will allow us to load the <strong>Az.Websites</strong> Azure PowerShell module which contains the command required to scale up an Azure App Service Plan.</p>
<pre><code class="language-plaintext">@{
    'Az' = "6.*"
    'Az.Websites' = "2.*"
}
</code></pre>
<p>As part of our generated code, we should also see a file called <strong>profile.ps1</strong>. Open it and replace the contents with the following. This will allow us to use the Azure Function’s managed identity to perform the scale up operation on the Azure App Service Plan.</p>
<pre><code class="language-plaintext">#Authenticate with Azure PowerShell using the function's managed identity
if ($env:MSI_SECRET) {
    Disable-AzContextAutosave -Scope Process | Out-Null
    Connect-AzAccount -Identity
}
</code></pre>
<p>As part of our generated code, we should also see a file called <strong>run.ps1</strong>. This file holds the code for the actual function. Replace the current contents of the file with the following code. Make sure to replace the placeholder <strong>&lt;appServicePlanName&gt;</strong> with the name of the Azure App Service Plan which we want to scale up. Replace the placeholder <strong>&lt;appServicePlanResourceGroupName&gt;</strong> with the name of the resource group which contains the Azure App Service Plan.</p>
<pre><code class="language-plaintext">using namespace System.Net

# Input bindings are passed in via param block.
param($Request, $TriggerMetadata)
# Scale up the app service plan to a S2 (Medium) Standard instance.
Set-AzAppServicePlan `
    -Name '&lt;appServicePlanName&gt;' `
    -ResourceGroupName '&lt;appServicePlanResourceGroupName&gt;' `
    -Tier Standard -WorkerSize Medium

# Associate values to output bindings by calling 'Push-OutputBinding'.
Push-OutputBinding -Name Response -Value ([HttpResponseContext]@{
    StatusCode = [HttpStatusCode]::OK
})
</code></pre>
<p>We’re done with writing our source code. Now we just need to deploy the code to an Azure Function. Before we proceed, we may need to run the following command in the PowerShell prompt to authenticate against the Azure subscription.</p>
<pre><code class="language-plaintext">Connect-AzAccount
</code></pre>
<p>We’re now going to run an Azure PowerShell script which will do the following:</p>
<ol>
  <li>Create an <strong>Azure Storage Account</strong></li>
  <li>Create an <strong>Azure Function App</strong> with a <strong>system-assigned managed identity</strong>.</li>
  <li>Assign the function app’s managed identity a role of <strong>Web Plan Contributor</strong> with our <strong>app service plan resource as the scope</strong>. This will give our function app the permission to scale up our app service plan.</li>
  <li>Publish our source code to the function app resource we created.</li>
</ol>
<p>For the script to work, make sure to replace the placeholders mentioned below with the correct values.</p>
<ul>
  <li>Replace <strong>&lt;location&gt; </strong>with the region we want to deploy the Azure Function in, for example <strong>EastUs</strong>. It would make sense to use the same location as the app service plan.</li>
  <li>Replace <strong>&lt;uniqueFunctionAppName&gt;</strong> with a globally unique name for our Azure Function App. This name will also be used for the storage account.</li>
  <li>Replace <strong>&lt;appServicePlanResourceGroup&gt;</strong> with the name of the resource group which contains the app service plan.</li>
  <li>Replace <strong>&lt;appServicePlanName&gt;</strong> with the name of the app service plan which we want to scale up.</li>
</ul>
<p>The script is below:</p>
<pre><code class="language-plaintext">#Replace placeholders &lt;&gt; below 
$location ="&lt;location&gt;"
$uniqueFunctionAppName= "&lt;uniqueFunctionAppName&gt;"
$appServicePlanResourceGroup="&lt;appServicePlanResourceGroup&gt;"
$appServicePlanName ="&lt;appServicePlanName&gt;"

#Create Storage Account
New-AzStorageAccount -ResourceGroupName $appServicePlanResourceGroup `
  -Name $uniqueFunctionAppName `
  -Location $location `
  -SkuName Standard_LRS `
  -Kind StorageV2

#Create Azure Function App
New-AzFunctionApp -Name $uniqueFunctionAppName `
    -ResourceGroupName $appServicePlanResourceGroup `
    -StorageAccount $uniqueFunctionAppName `
    -Runtime PowerShell `
    -FunctionsVersion 3 `
    -Location $location `
    -IdentityType SystemAssigned

#Get Azure Function App details
$funcApp = Get-AzFunctionApp `
    -Name $uniqueFunctionAppName `
    -ResourceGroupName $appServicePlanResourceGroup

#Get Azure App Service Plan which we want to scale up
$appServicePlan = Get-AzAppServicePlan `
    -Name $appServicePlanName `
    -ResourceGroupName $appServicePlanResourceGroup

#Assign the function app the Web Plan Contributor role for the app service plan
New-AzRoleAssignment -ObjectId $funcApp.IdentityPrincipalId `
    -RoleDefinitionName "Web Plan Contributor" `
    -Scope $appServicePlan.Id

start-sleep -Seconds 10
#Publish the function source code to the azure function resource
func azure functionapp publish $uniqueFunctionAppName
</code></pre>
<p>After running the above script successfully, if we were to manually trigger the Azure Function, our app service plan should scale up to the Standard S2 tier. However, we want to automatically scale up our app service plan when its CPU usage exceeds 75%. To do that let’s move on to the next part: creating an alert with an action group on the app service plan.</p>
<h2>Create the Alert and Action Group</h2>
<p>Azure Monitor gives us the ability to fire an alert when certain configurable conditions are met. These conditions can be based on <strong>log queries</strong>, <strong>activity logs</strong> or <strong>metrics</strong>. In our example, we’ll be using a metric-based condition for our alert, because we want to take an action when the CPU usage is greater than 75%.</p>
<p>An alert on its own will not do much. To be notified of an alert or to take an automatic action in response to an alert, we have to associate it with an action group. For our case, we will create an action group which triggers the Azure Function we created in the previous section.</p>
<p>We have provided an Azure PowerShell script which will create both the action group and the alert. Note that this PowerShell script actually includes commands which use the Azure CLI, so make sure it is installed! We can go ahead and run the following script in the PowerShell prompt:</p>
<pre><code class="language-plaintext">$actionGroupReceiverName = "ScaleUpFunctionReceiver"
$actionGroupName = "ScaleUpActionGroup"
$actionshortName = "ScaleUp"
$alertRuleName = "CPU High"

#Get the base URL of the HTTP-triggered function
$functionBaseUrl = az functionapp function show `
    --function-name ScaleUp `
    --name $uniqueFunctionAppName `
    --resource-group $appServicePlanResourceGroup `
    --query "invokeUrlTemplate" `
    --output tsv

#Get the authorization code for the HTTP-triggered function
$functionKey = az functionapp function keys list `
    --function-name ScaleUp `
    --name $uniqueFunctionAppName `
    --resource-group $appServicePlanResourceGroup `
    --query "default" `
    --output tsv

#Combine the auth code and base URL into one request URL     
$functionUrl =$functionBaseUrl + "?code=" + $functionKey

#Create a receiver for the action group which calls the function
$functionReceiver = New-AzActionGroupReceiver `
    -Name $actionGroupReceiverName `
    -FunctionAppResourceId $funcApp.Id `
    -HttpTriggerUrl $functionUrl `
    -FunctionName $uniqueFunctionAppName

#Create the action group to be used with the alert
$actionGroup = Set-AzActionGroup -Name $actionGroupName `
    -ResourceGroup $appServicePlanResourceGroup `
    -ShortName $actionshortName `
    -Receiver $functionReceiver 

#Create the condition for which the alert will fire (CPU &gt;75%)
$condition = New-AzMetricAlertRuleV2Criteria `
    -MetricName "CpuPercentage" `
    -MetricNameSpace "Microsoft.Web/serverFarms" `
    -TimeAggregation Average `
    -Operator GreaterThan -Threshold 75

#Create the alert rule for the app service plan
$alert = Add-AzMetricAlertRuleV2 `
    -Name $alertRuleName `
    -ResourceGroupName $appServicePlanResourceGroup `
    -WindowSize 0:5 `
    -Frequency 0:5 `
    -TargetResourceId $appServicePlan.Id `
    -Condition $condition `
    -ActionGroupId $actionGroup.Id `
    -Severity 2
</code></pre>
<p>And we’re done! If our app service plan’s CPU usage exceeds 75%, our function will get triggered and it will scale up the app service plan to Standard S2.</p>
<h2>An Alternative Approach</h2>
<p>Instead of using an Azure Function to scale up our app service plan, we could have used an <strong>Azure Automation Runbook</strong>. The rest of the solution would remain the same:</p>
<figure class="image image_resized" style="width:680px;"><img src="https://i1.wp.com/permanentiteration.com/wp-content/uploads/2021/07/scaleUpAppServicePlanAutomation.png?resize=431%2C271&amp;ssl=1" alt="" srcset="https://i1.wp.com/permanentiteration.com/wp-content/uploads/2021/07/scaleUpAppServicePlanAutomation.png?w=431&amp;ssl=1 431w, https://i1.wp.com/permanentiteration.com/wp-content/uploads/2021/07/scaleUpAppServicePlanAutomation.png?resize=300%2C189&amp;ssl=1 300w" sizes="100vw" width="431"></figure>
<p>If we wanted to use an Azure Automation Runbook rather than an Azure Function, instead of using the steps in the Create and Deploy the Azure Function section, we would do the following:</p>
<ol>
  <li>Create an <strong>Azure Automation Account</strong>.</li>
  <li>Enable the system-assigned managed identity for the created automation account.</li>
  <li>Give the managed identity a role assignment for the role <strong>Web Plan Contributor</strong> with the scope being the app service plan to scale up.</li>
  <li>Import the Az.Websites PowerShell module into the automation account.</li>
  <li>Create a runbook with the following code:</li>
</ol>
<pre><code class="language-plaintext">Import-Module Az.Websites
#Authenticate using the managed identity
Connect-AzAccount -Identity
Set-AzContext -Subscription "73efad4a-5557-4af3-98fd-097c0f81957f"
#Scale up the app service plan
Set-AzAppServicePlan `
    -Name 'scaletestzee' `
    -ResourceGroupName 'scaletestzee' `
    -Tier Standard -WorkerSize Medium
</code></pre>
<p>Of course, we would also have to modify the script to create the action group so that it runs the automation runbook instead of calling an Azure Function.</p>
<h2>Closing Thoughts</h2>
<p>We’ve now seen how to automatically scale up an Azure App Service Plan based on performance metrics by using Azure Monitor and an Azure Function. We’ve also looked at alternative solution which replaces the Azure Function with an Azure Automation Runbook.</p>
<p>There are some limitations of the solution we’ve presented above. One of them is that the app service plan doesn’t automatically scale back down to its previous level based on metrics. For this reason, I’d recommend adding an e-mail notification to the alert’s action group, so that someone knows to manually scale the app service plan back down when appropriate.</p>
<p>Another limitation is that we’ve only allowed ourselves to scale up one level to a Standard S2 instance. However, this can be easily fixed by modifying the Azure Function code so that it scales to Standard S3 if the instance is already at Standard S2 and so on.</p>
