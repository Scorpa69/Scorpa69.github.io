<!--
title: ADCS
description: 
published: true
date: 2023-09-18T12:37:43.233Z
tags: 
editor: ckeditor
dateCreated: 2023-09-18T12:37:41.693Z
-->

<h1>Liste Modèle certificat d'une CA :</h1>
<p>certutil -config vdcsacs01.cyborg.dom\SIDFDC01 –catemplates &gt; templates.txt</p>
<p>OU (-config CAHostName\CAName)</p>
<p>certutil -config vdcsacs01.cyborg.dom\SIDFDC01 –catemplates</p>
<h1>Création du CSR linux Apache</h1>
<p>&nbsp;</p>
<ol>
  <li>mkdir /root/certs/ &amp;&amp; cd /root/certs/</li>
  <li>openssl req -newkey rsa:2048 -nodes -keyout vdcstpm01.cyborg.dom.key -out vdcstpm01.cyborg.dom.csr</li>
</ol>
<p>&nbsp;</p>
<h1>Validation du CSR dans l'AD CS</h1>
<p>&nbsp;</p>
<ol>
  <li>Ouvrir un navigateur à l'adresse :&nbsp; <a href="https://vidfads01.cyborg.dom/certsrv/">https://nomdelaCA/certsrv/</a></li>
  <li>Cliquer sur Demander un certificat puis&nbsp; demande certificat avancée et Sélectionner le profil Web Server</li>
  <li>Copier la clé du CSR puis envoyer</li>
  <li>Télécharger le certificat en base64 (fichier au format CER)</li>
</ol>
<p>&nbsp;</p>
<h1>Migration de l'AD CS d'un serveur à un autre avec changement du nom du serveur</h1>
<p>PROCEDURE : Microsoft préconise de n'avoir le rôle AD CS que sur un seul serveur à la fois lors d'une migration d'AD CS unique dans un domaine</p>
<ol>
  <li>Créer un dossier c:\BackupCA</li>
  <li>Faire une sauvegarde de la CA : clique droit sur l'autorité puis sauvegarde CA dans c:\BackupCA puis créer et sauvegarder un mot de passe fort</li>
  <li>net stop certsvc</li>
  <li>Exporter la clé dans c:\BackupCA\Reg_vidfads01_CA.reg :&nbsp; &nbsp; &nbsp; HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\CertSvc\Configuration (se positionner un niveau au-dessus en graphique pour exporter)</li>
  <li>Copier le dossier de sauvegarde de l'ancien vers le nouveau serveur CA (VDCSACS01)</li>
  <li>Désinstaller le rôle AD CS uniquement (laisser IIS) =&gt; reboot server à la fin</li>
  <li>Installer le rôle AD CS avec Certificate Authority and Certification Authority Web Enrollment sur le nouveau (a faire uniquement quand la source n'a plus le rôle AD CS)</li>
  <li>Configurer le rôle CA sur le nouveau avec Use existing private key and Select a certificate and use its associated private key restauration de la clé source)</li>
  <li>net stop certsvc</li>
  <li>ouvrir le fichier reg dans un notepad et modifier le fqdn du serveur dans la clé "CASERVERNAME" puis enregistrer</li>
  <li>Importer la config de la source depuis C:\BackupCA avec un des commande ci-dessous (la première en cmd ou la seconde en PS)</li>
  <li>Reg import "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\CertSvc\Configuration" "C:\BackupCA\Reg_vidfads01_CA.reg" /y</li>
  <li>net start certsvc</li>
  <li>Vérifier dans les propriétés de la CA (onglet "extensions") : les chemin et leur config pour CDP et AIA (voir ci-dessus pour les chemin exacte)</li>
  <li>Re-Issue de chaque template personnalisé de certificat manquant par rapport à la liste ci-dessus</li>
  <li>Tester un renouvèlement du certif de ma machine avec la même clé depuis mon poste</li>
  <li>Étape suivante : Migrer le IIS sur VDCSACS01 (structure dossier IIS + droit sur dossier et redirection DNS à modifier et lancer la tâche de publication de la liste de certificat révoqués manuellement depis la console CA)</li>
</ol>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>certutil.exe -f -restoredb &lt;CA Database Backup Directory&gt;</p>
<p>OU</p>
<p>Restore-CARoleService C:\BackupCA</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>Log CA level :</p>
<p>certutil.exe -f -setreg ca\debug 0xffffffff =&gt; Enable full log&nbsp;</p>
<p>&nbsp;</p>
<p>certutil.exe -f -setreg ca\debug 0x0 =&gt; Disable logs</p>
