<!--
title: TEAM PASSWORD MANAGER
description: 
published: true
date: 2024-03-01T10:12:41.996Z
tags: 
editor: ckeditor
dateCreated: 2023-09-18T12:36:05.231Z
-->

<h1>Version PROD:</h1>
<pre><code class="language-plaintext">version: '3.7'
services:
  tpm:
    container_name: tpm
    hostname: tpm.tpm.loc
    depends_on:
      - mysql
    image: teampasswordmanager/teampasswordmanager:12.154.276 #12.146.268 12.147.270 12.152.275 12.154.276
    networks:
      frontend:
      backend:
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./volume/app:/var/www/html:rw
      - ./upload:/var/www/html/upload:rw
      - ./lang/fr20:/var/www/html/site/system/language/fr:ro # à commenter au premier lancement
      - ./conf/config.php:/var/www/html/site/config.php:ro # à commenter au premier lancement
      - ./conf/02-teampasswordmanager.ini:/etc/php/8.2/apache2/conf.d/02-teampasswordmanager.ini:ro # à commenter au premier lancement
      - ./cert/wildcard_ac.crt:/var/www/html/ssl/tpm-ssl-cert.crt:ro
      - ./cert/wildcard_ac.key:/var/www/html/ssl/tpm-ssl-key.key:ro
    environment:
      TPM_SERVER_TIMEZONE: Europe/Paris
      TPM_PHP_TIMEZONE: Europe/Paris
      TPM_UPGRADE: '0'
    cap_drop: # à exclure au premier lancement
      - NET_ADMIN
 # à commenter au premier lancement
      - SYS_ADMIN # à commenter au premier lancement
    deploy:
      resources:
        limits:
          cpus: "0.2"
          memory: 256M
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 5
        window: 120s
    restart: on-failure
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost"]
      interval: 30s
      timeout: 5s
      retries: 3
  mysql:
    container_name: mysql
    hostname: mysql.tpm.loc
    image: mysql:8.0.35-debian
    networks:
      backend:
        ipv4_address: 172.100.200.10
    volumes:
      - ./volume/bdd:/var/lib/mysql:rw
      - ./conf/my.cnf:/etc/mysql/my.cnf:ro
    environment:
      - TZ=Europe/Paris
      - MYSQL_USER=tpm_user
      - MYSQL_PASSWORD_FILE=/run/secrets/sql_user
      - MYSQL_DATABASE=tpm_db
      - MYSQL_ROOT_PASSWORD_FILE=/run/secrets/sql_root
    secrets:
      - sql_user
      - sql_root
    cap_drop:  # à commenter au premier lancement
      - NET_ADMIN  # à commenter au premier lancement
      - SYS_ADMIN  # à commenter au premier lancement
    command:
      - mysqld
      - --bind-address=0.0.0.0 # permet d'accéder au conteneur mysql depuis l'hôte
      - --innodb_buffer_pool_size=256M
      - --innodb_redo_log_capacity=64M
      - --innodb_flush_log_at_trx_commit=0
      - --innodb_flush_method=O_DIRECT
      - --pid-file=/var/run/mysqld/mysqld.pid
      - --default-authentication-plugin=caching_sha2_password
      - --host_cache_size=0
    deploy:
      resources:
        limits:
          cpus: "0.6"
          memory: 1024M
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 5
        window: 120s
    restart: on-failure
    healthcheck:
      test: ["CMD-SHELL", 'mysqladmin ping -h localhost -uzabbix_monitor']
      interval: 30s
      timeout: 5s
      retries: 3
    stop_grace_period: 1m


networks:
  frontend:
    driver: "bridge"
    ipam:
      config:
        - subnet: "172.100.200.0/29"

  backend:
    driver: "bridge"
    #internal: "true" on peut décommenter si pas de monitoring mysql depuis l'hote
    ipam:
      config:
        - subnet: "172.100.200.8/29"
secrets:
  sql_user:
    file: ./sec/.up
  sql_root:
    file: ./sec/.rp</code></pre>
<h1>Version PREPROD :</h1>
<pre><code class="language-plaintext">version: '3.3'

services:

  tpmdev:
    image: teampasswordmanager/teampasswordmanager:12.146.268
    cap_drop:
      - NET_ADMIN
      - SYS_ADMIN
    security_opt:
      - no-new-privileges=true
    deploy:
      resources:
        limits:
          cpus: '0.2'
          memory: 1024M
          pids: 100
        reservations:
          cpus: '0.1'
          memory: 256M
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 5
        window: 120s
    depends_on:
      - mysql
    restart: on-failure
    container_name: tpmdev
    hostname: tpmdev.cyborg.dom
    ports:
      - "80:80"
      - "443:443"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost"]
      interval: 30s
      timeout: 5s
      retries: 3
    volumes:
      - /docker/data/tpmdev/app:/var/www/html:rw
      - ./conf/02-teampasswordmanager.ini:/etc/php/8.1/apache2/conf.d/02-teampasswordmanager.ini:ro 
      - ./cert/vdcstpm01-dev.crt:/var/www/html/ssl/tpm-ssl-cert.crt:ro
      - ./cert/vdcstpm01-dev.key:/var/www/html/ssl/tpm-ssl-key.key:ro
    networks:
      - frontend
      - backend
    environment:
      TPM_SERVER_TIMEZONE: Europe/Paris
      TPM_PHP_TIMEZONE: Europe/Paris
      TPM_CONFIG_HOSTNAME: mysql
      TPM_CONFIG_PORT: 3306
      TPM_CONFIG_USERNAME: tpm_user
      TPM_CONFIG_PASSWORD_FILE: /run/secrets/sql_user
      TPM_CONFIG_DATABASE: tpm_db
      TPM_ENCRYPT_DB_CONFIG: 0
      TPM_UPGRADE: 0
    secrets:
      - sql_user

  mysql:
    image: mysql:5.7
    cap_drop:
      - NET_ADMIN
      - SYS_ADMIN
    security_opt:
      - no-new-privileges=true
    deploy:
      resources:
        limits:
          cpus: '1.6'
          memory: 1024M #8192
          pids: 100
        reservations:
          cpus: '0.8'
          memory: 512M #4096
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 5
        window: 120s
    restart: on-failure
    container_name: mysql
    hostname: mysql.cyborg.dom
    healthcheck:
      test: ["CMD-SHELL", 'mysqladmin ping -h localhost -uroot']
      interval: 30s
      timeout: 5s
      retries: 3
    volumes:
      - /docker/data/tpmdev/sql:/var/lib/mysql:rw
    networks:
      - backend
    command:
      - mysqld
      - --innodb_buffer_pool_size=512M
      - --innodb_log_file_size=64M
      - --innodb_flush_log_at_trx_commit=0
      - --innodb_flush_method=O_DIRECT
      - --pid-file=/var/run/mysqld/mysqld.pid
    environment:
      MYSQL_USER: tpm_user
      MYSQL_PASSWORD_FILE: /run/secrets/sql_user
      MYSQL_DATABASE: tpm_db
      MYSQL_ROOT_PASSWORD_FILE: /run/secrets/sql_root
    secrets:
      - sql_user
      - sql_root

networks:
  frontend:
    driver: "bridge"
  backend:
    driver: "bridge"

secrets:
  sql_user:
    file: ./sec/ucr.txt
  sql_root:
    file: ./sec/rcr.txt</code></pre>
<p><br>&nbsp;</p>
<h1>Version Editeur :</h1>
<pre><code class="language-plaintext">version: '3'

services:

 teampasswordmanager:
   image: teampasswordmanager/teampasswordmanager:latest
   depends_on:
     - mysql
   restart: always
   ports:
     - "80:80"
     - "443:443"
   volumes:
     - tpm_volume:/var/www/html
   networks:
    - tpm_network
   environment:
     - TPM_SERVER_TIMEZONE=Etc/UTC
     - TPM_PHP_TIMEZONE=Etc/UTC
     - TPM_ENCRYPT_DB_CONFIG=0
     - TPM_CONFIG_HOSTNAME=mysql
     - TPM_CONFIG_PORT=3306
     - TPM_CONFIG_USERNAME=tpm_user
     - TPM_CONFIG_PASSWORD=tpm_password
     - TPM_CONFIG_DATABASE=tpm_database
     - TPM_UPGRADE=0

 mysql:
   image: mysql:5.7
   restart: always
   ports:
     - "13306:3306"
   volumes:
     - tpm_mysqldata:/var/lib/mysql  
   networks:
    - tpm_network
   environment:
     - MYSQL_USER=tpm_user
     - MYSQL_PASSWORD=tpm_password
     - MYSQL_DATABASE=tpm_database
     - MYSQL_ROOT_PASSWORD=password5.7

networks:
 tpm_network:
   driver: "bridge"

volumes:
 tpm_mysqldata:
   driver: "local"
 tpm_volume:
   driver: "local"</code></pre>
