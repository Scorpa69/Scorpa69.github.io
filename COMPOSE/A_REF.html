<!--
title: A_REF
description: 
published: true
date: 2024-01-04T13:34:46.426Z
tags: 
editor: ckeditor
dateCreated: 2024-01-04T09:35:18.050Z
-->

<h1>Exemple Complet de PROD avec Zabbix</h1>
<h2>Structure dossier : (vue VS CODE)</h2>
<figure class="image"><img src="/2024-01-04_10_31_30-docker-compose.yml_-_compose_[ssh__zabdok]_-_visual_studio_code.jpg"></figure>
<h2>Droit Dossiers :</h2>
<figure class="image"><img src="/2024-01-04_14_26_07-agt_cli_mysql.conf_-_compose_[ssh__zabdokdev]_-_visual_studio_code.jpg"></figure>
<figure class="image"><img src="/2024-01-04_14_29_19-agt_cli_mysql.conf_-_compose_[ssh__zabdokdev]_-_visual_studio_code.jpg"></figure>
<figure class="image"><img src="/2024-01-04_14_29_48-agt_cli_mysql.conf_-_compose_[ssh__zabdokdev]_-_visual_studio_code.jpg"></figure>
<figure class="image"><img src="/2024-01-04_14_29_34-agt_cli_mysql.conf_-_compose_[ssh__zabdokdev]_-_visual_studio_code.jpg"></figure>
<figure class="image"><img src="/2024-01-04_14_31_13-agt_cli_mysql.conf_-_compose_[ssh__zabdokdev]_-_visual_studio_code.jpg"></figure>
<figure class="image"><img src="/2024-01-04_14_30_07-agt_cli_mysql.conf_-_compose_[ssh__zabdokdev]_-_visual_studio_code.jpg"></figure>
<p>&nbsp;</p>
<h2>Compose :</h2>
<pre><code class="language-plaintext">version: '3.7'

services:

 zbx:
   container_name: zbx
   hostname: zbx.zbx.loc
   depends_on:
     - mysql-server
   build:
     context: /compose/build/zbx60xodbc
     dockerfile: Dockerfile
   networks:
     frt:
     bck:
       ipv4_address: 182.192.168.11
   ports:
     - "10051:10051"
   volumes:
     - /etc/localtime:/etc/localtime:ro
     - /etc/timezone:/etc/timezone:ro
     - ./conf/odbcinst.ini:/etc/odbcinst.ini:ro
     - ./conf/odbc.ini:/etc/odbc.ini:ro
     - /var/lib/docker/500000.500000/data/zbx/zbxvar:/var/lib/zabbix:rw
   environment:
     - MYSQL_USER_FILE=/run/secrets/sql_user
     - MYSQL_PASSWORD_FILE=/run/secrets/sql_pass
     - MYSQL_ROOT_PASSWORD_FILE=/run/secrets/sql_rt_pass
     - ZBX_JAVAGATEWAY_ENABLE=false
     - ZBX_STARTJAVAPOLLERS=0
     - ZBX_ENABLE_SNMP_TRAPS=false
     - ZBX_STARTPOLLERS=100
     - ZBX_IPMIPOLLERS=5
     - ZBX_STARTPREPROCESSORS=15
     - ZBX_STARTPOLLERSUNREACHABLE=50
     - ZBX_STARTTRAPPERS=10
     - ZBX_STARTPINGERS=50
     - ZBX_STARTDISCOVERERS=15
     - ZBX_STARTODBCPOLLERS=10
     - ZBX_STARTHTTPPOLLERS=10
     - ZBX_STARTHISTORYPOLLERS=10
     - ZBX_STARTESCALATORS=3
     - ZBX_STARTALERTERS=5
     - ZBX_CACHESIZE=128M
     - ZBX_HISTORYCACHESIZE=64M
     - ZBX_HISTORYINDEXCACHESIZE=32M
     - ZBX_TRENDCACHESIZE=16M
     - ZBX_VALUECACHESIZE=512M
     - ZBX_TIMEOUT=20
   secrets:
     - sql_user
     - sql_pass
     - sql_rt_pass
   cap_add:
     - NET_RAW
   sysctls:
     - net.ipv4.ip_forward=1
     - net.ipv4.ip_local_port_range=1024 64999
     - net.ipv4.conf.all.accept_redirects=0
     - net.ipv4.conf.all.secure_redirects=0
     - net.ipv4.conf.all.send_redirects=0
     - net.ipv4.ping_group_range=0 2000
   deploy:
     resources:
       limits:
         cpus: "0.40"
         memory: 2G
     restart_policy:
       condition: on-failure
       delay: 5s
       max_attempts: 5
       window: 120s
   stop_grace_period: 30s
   restart: on-failure

 mysql-server:
   container_name: mysql-server
   hostname: mysql-server.zbx.loc
   image: mysql:8.0.35-debian
   networks:
     - bck
   volumes:
     - /etc/localtime:/etc/localtime:ro
     - /etc/timezone:/etc/timezone:ro
     - /var/lib/docker/500000.500000/data/zbx/sql:/var/lib/mysql:rw
   environment:
     - MYSQL_USER_FILE=/run/secrets/sql_user
     - MYSQL_PASSWORD_FILE=/run/secrets/sql_pass
     - MYSQL_ROOT_PASSWORD_FILE=/run/secrets/sql_rt_pass
   secrets:
     - sql_user
     - sql_pass
     - sql_rt_pass
   cap_add:
     - SYS_NICE
   command:
     - mysqld
     - --skip_ssl
     - --default-authentication-plugin=caching_sha2_password
     - --innodb_buffer_pool_size=2G
     - --innodb_buffer_pool_instances=8
     - --innodb_flushing_avg_loops=10
     - --innodb-log-buffer-size=128M
     - --innodb_redo_log_capacity=128M
     - --innodb_flush_log_at_trx_commit=0
     - --innodb_flush_method=O_DIRECT
     - --innodb_io_capacity=2000
     - --innodb_io_capacity_max=4000
     - --binlog_expire_logs_seconds=86400
     - --max_connections=250
     - --tmp_table_size=96M
     - --max_heap_table_size=96M
     - --thread_cache_size=100
     - --open_files_limit=65535
     - --max_connect_errors=1000000
     - --connect_timeout=60  
   deploy:
     resources:
       limits:
         cpus: "0.40"
         memory: 4G
     restart_policy:
       condition: on-failure
       delay: 5s
       max_attempts: 5
       window: 120s
   stop_grace_period: 1m
   restart: on-failure

 web:
   container_name: web
   hostname: web.zbx.loc
   depends_on:
     - mysql-server
     - zbx
   image: zabbix/zabbix-web-apache-mysql:alpine-6.0.25
   networks:
     frt:
     bck:
       ipv4_address: 182.192.168.12
   ports:
     - "443:8443"
     - "80:8080"
   volumes:
     - /etc/localtime:/etc/localtime:ro
     - /etc/timezone:/etc/timezone:ro
     - ./cert/vdcszab02.key:/etc/ssl/apache2/ssl.key
     - ./cert/vdcszab02.crt:/etc/ssl/apache2/ssl.crt
   environment:
     - MYSQL_USER_FILE=/run/secrets/sql_user
     - MYSQL_PASSWORD_FILE=/run/secrets/sql_pass
     - ZBX_SERVER_HOST=zbx
     - ZBX_SERVER_NAME=ZABBIX-PROD
     - ZBX_DB_ENCRYPTION=false
     - PHP_TZ=Europe/Paris
   secrets:
     - sql_user
     - sql_pass
     - sql_rt_pass
   deploy:
     resources:
       limits:
         cpus: "0.30"
         memory: 512M
     restart_policy:
       condition: on-failure
       delay: 5s
       max_attempts: 5
       window: 120s
   stop_grace_period: 10s
   restart: on-failure

 
 agt:
   container_name: agt
   hostname: agt.zbx.loc
   depends_on:
     - mysql-server
     - zbx
     - web
   build:
     context: /compose/build/agt60xmysql
     dockerfile: Dockerfile
   networks:
     - bck  
   ports:
     - "10050:10050"
   volumes:
     - /etc/localtime:/etc/localtime:ro
     - /etc/timezone:/etc/timezone:ro
     - ./conf/user_mon_mysql.conf:/etc/mysql/my.cnf
     - ./conf/agt_cli_mysql.conf:/etc/zabbix/zabbix_agentd.d/userparameter_mysql.conf
   environment:
     - ZBX_SERVER_HOST=zbx
     - ZBX_ACTIVE_ALLOW=false
   deploy:
     resources:
       limits:
         cpus: "0.01"
         memory: 256M
     restart_policy:
       condition: on-failure
       delay: 5s
       max_attempts: 5
       window: 120s
   stop_grace_period: 5s
   restart: on-failure

networks:
 frt:
   driver: bridge
   ipam:
     config:
       - subnet: 182.192.168.0/29
 bck:
   driver: bridge
   ipam:
     config:
       - subnet: 182.192.168.8/29


secrets:
 sql_user:
   file: /compose/zbx/sec/.un
 sql_pass:
   file: /compose/zbx/sec/.up
 sql_rt_pass:
   file: /compose/zbx/sec/.rp</code></pre>
<h2>Dokerfile : (Ã  mettre dans un dossier build)</h2>
<h3>Server :</h3>
<pre><code class="language-plaintext">FROM zabbix/zabbix-server-mysql:alpine-6.0.25
USER root
# Install Microsoft ODBC driver
RUN apk add --no-cache curl gnupg &amp;&amp; \
    curl -O https://download.microsoft.com/download/e/4/e/e4e67866-dffd-428c-aac7-8d28ddafb39b/mssql-tools_17.10.1.1-1_amd64.apk \
    &amp;&amp; curl -O https://download.microsoft.com/download/e/4/e/e4e67866-dffd-428c-aac7-8d28ddafb39b/msodbcsql17_17.10.5.1-1_amd64.apk \
    &amp;&amp; apk add --allow-untrusted msodbcsql17_17.10.5.1-1_amd64.apk \
    &amp;&amp; apk add --allow-untrusted mssql-tools_17.10.1.1-1_amd64.apk \
    &amp;&amp; rm -rf /var/cache/apk/* \
    &amp;&amp; chmod u+s /usr/sbin/fping
EXPOSE 10051/TCP
WORKDIR /var/lib/zabbix
ENTRYPOINT ["/sbin/tini", "--", "/usr/bin/docker-entrypoint.sh"]
USER 1997
#Demarrage server
CMD ["/usr/sbin/zabbix_server", "--foreground", "-c", "/etc/zabbix/zabbix_server.conf"]</code></pre>
<h3>Agent :</h3>
<pre><code class="language-plaintext">FROM zabbix/zabbix-agent:alpine-6.0.25
USER root
RUN apk add mysql-client &amp;&amp; rm -rf /var/cache/apk/*
USER 1997
CMD ["/usr/sbin/zabbix_agentd", "--foreground", "-c", "/etc/zabbix/zabbix_agentd.conf"]</code></pre>
<h2>Conf :</h2>
<h3>agt_<i>cred_</i>mysql.conf : (user mon sur le screenshot plus haut)</h3>
<pre><code class="language-plaintext">[client]
user='zabbix_monitor'
password='pass'
host='mysql-server.zbx.loc'</code></pre>
<h3>agt_<i>zbx</i>_mysql.conf : (agt cli sur le screenshot plus haut)</h3>
<pre><code class="language-plaintext">UserParameter=mysql.ping[*], mysqladmin -h"$1" -P"$2" ping
UserParameter=mysql.get_status_variables[*], mysql -h"$1" -P"$2" -sNX -e "show global status"
UserParameter=mysql.version[*], mysqladmin -s -h"$1" -P"$2" version
UserParameter=mysql.db.discovery[*], mysql -h"$1" -P"$2" -sN -e "show databases"
UserParameter=mysql.dbsize[*], mysql -h"$1" -P"$2" -sN -e "SELECT COALESCE(SUM(DATA_LENGTH + INDEX_LENGTH),0) FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA='$3'"
UserParameter=mysql.replication.discovery[*], mysql -h"$1" -P"$2" -sNX -e "show slave status"
UserParameter=mysql.slave_status[*], mysql -h"$1" -P"$2" -sNX -e "show slave status"</code></pre>
<h3>odbc.ini :</h3>
<pre><code class="language-plaintext">[SIDFSLX01]
Driver = ODBC Driver 17 for SQL Server
Server = tcp:SIDFSLX01.cyborg.dom,49374

[SIDFDKS01]
Driver = ODBC Driver 17 for SQL Server
Server = tcp:SIDFDKS01.cyborg.dom,1433

[SIDFTAL01]
Driver = ODBC Driver 17 for SQL Server
Server = tcp:SIDFTAL01.cyborg.dom,1433

[VDCSADMIN/SQL2014]
Driver = ODBC Driver 17 for SQL Server
Server = tcp:VDCSADMIN.cyborg.dom,49843

[VDCSPAI01]
Driver = ODBC Driver 17 for SQL Server
Server = tcp:VDCSPAI01.cyborg.dom,1433

[VDCSVPS01]
Driver = ODBC Driver 17 for SQL Server
Server = tcp:VDCSVPS01.cyborg.dom,1433

[VIDFACA201501]
Driver = ODBC Driver 17 for SQL Server
Server = tcp:VIDFACA201501.cyborg.dom,49555

[VDCSRPT01]
Driver = ODBC Driver 17 for SQL Server
Server = tcp:VDCSRPT01.cyborg.dom,1433

[VIDFSCB02]
Driver = ODBC Driver 17 for SQL Server
Server = tcp:VIDFSCB02.cyborg.dom,1433

[VIDFETL01/SQL2016ENT]
Driver = ODBC Driver 17 for SQL Server
Server = tcp:VIDFETL01.cyborg.dom,1433</code></pre>
<h3>odbcinst.ini :</h3>
<pre><code class="language-plaintext">[ODBC Driver 17 for SQL Server]
Description=Microsoft ODBC Driver 17 for SQL Server
Driver=/opt/microsoft/msodbcsql17/lib64/libmsodbcsql-17.10.so.5.1
Setup=/opt/microsoft/msodbcsql17/lib64/libmsodbcsql-17.10.so.5.1
UsageCount=1</code></pre>
